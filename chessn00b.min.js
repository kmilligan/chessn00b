var BoardFactory;
(function(){"function"!==typeof Object.create&&(Object.create=function(d){function a(){}a.prototype=d;return new a});var n={R:"\u2656",N:"\u2658",B:"\u2657",Q:"\u2655",K:"\u2654",P:"\u2659",r:"\u265c",n:"\u265e",b:"\u265d",q:"\u265b",k:"\u265a",p:"\u265f",isWhite:function(d){if("string"!=typeof d)throw Error('Got a non-string piece "'+d+'"');return 91>d.charCodeAt(0)?!0:!1},getColor:function(d){return this.isWhite(d)?k.white:k.black}},l={1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",a:"1",b:"2",
c:"3",d:"4",e:"5",f:"6",g:"7",h:"8",name:function(d,a){return l[d]+a},coords:function(d){return{file:parseInt(l[d.substr(0,1)],10),rank:parseInt(d.substr(1,1),10)}}},k={white:8,black:0},q={init:function(){this.colorToMove=k.white;this.enpassantTarget=this.castlingOptions="-";this.fullMoveNumber=this.halfMoveClock=0;this.squares=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,
-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];this.squareColors=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];return this},copyFrom:function(d){this.squares=d.squares.slice();
this.colorToMove=d.colorToMove;this.castlingOptions=d.castlingOptions;this.enpassantTarget=d.enpassantTarget;this.haveMoveClock=d.halfMoveClock;this.fullMoveNumber=d.fullMoveNumber},setFEN:function(d){d=d.split(" ");for(var a=d[0].split("/"),b=8;0<b;b--)this.setRankFEN(b,a[8-b]);this.colorToMove="w"==d[1]?k.white:k.black;d[2]&&(this.castlingOptions=d[2]);d[3]&&(this.enpassantTarget=d[3]);"undefined"!=typeof d[4]&&(this.halfMoveClock=parseInt(d[4],10));"undefined"!=typeof d[5]&&(this.fullMoveNumber=
parseInt(d[5],10))},setRankFEN:function(d,a){var b=a.split(""),c=1,m;for(m in b){if(8<c||" "==b[m])break;if(n[b[m]])this.setPiece(b[m],c,d),c++;else for(;0<b[m];)this.removePiece(c,d),b[m]--,c++}},getColorToMove:function(){return this.colorToMove},incrementMove:function(){this.colorToMove==k.white?this.colorToMove=k.black:(this.colorToMove=k.white,this.fullMoveNumber++)},ap:function(d,a){return 10*(10-parseInt(a,10))+parseInt(d,10)},apToName:function(d){return l.name(d%10,10-Math.floor(d/10))},setPiece:function(d,
a,b){this.squares[this.ap(a,b)]=d},removePiece:function(d,a){this.squares[this.ap(d,a)]=0},hasPiece:function(d,a){var b;b="undefined"===typeof a?d:this.ap(d,a);return"string"===typeof this.squares[b]?!0:!1},getPiece:function(d,a){return this.squares[this.ap(d,a)]},getPieceCount:function(){for(var d=0,a=8;0<a;a--)for(var b=1;9>b;b++)this.hasPiece(b,a)&&d++;return d},getSquareColor:function(d,a){"undefined"==typeof a&&"string"==typeof d&&(a=d.substr(1,1),d=l[d.substr(0,1)]);return this.squareColors[this.ap(d,
a)]},getCoveredSquares:function(d,a){var b=[],c=[];switch(this.getPiece(d,a)){case "K":case "k":b=this.getStraightOptions(d,a,1);c=this.getDiagonalOptions(d,a,1);break;case "Q":case "q":b=this.getStraightOptions(d,a,8);c=this.getDiagonalOptions(d,a,8);break;case "R":case "r":b=this.getStraightOptions(d,a,8);break;case "B":case "b":c=this.getDiagonalOptions(d,a,8);break;case "N":case "n":b=this.getKnightOptions(d,a);break;case "P":case "p":b=this.getPawnOptions(d,a)}for(var m=0;m<c.length;m++)b.push(c[m]);
return b},getStraightOptions:function(d,a,b){for(var c=[],m=[-1,-10,1,10],e=this.ap(d,a),g,f=0;f<m.length;f++)for(a=m[f],g=e,d=0;d<b;){g+=a;if(0>this.squares[g])break;c.push(this.apToName(g));if(this.hasPiece(g))break;d++}return c},getDiagonalOptions:function(d,a,b){for(var c=[],m=[-11,-9,9,11],e=this.ap(d,a),g,f=0;f<m.length;f++)for(a=m[f],g=e,d=0;d<b;){g+=a;if(0>this.squares[g])break;c.push(this.apToName(g));if(this.hasPiece(g))break;d++}return c},getKnightOptions:function(d,a){for(var b=[],c=[-21,
-19,-8,12,21,19,8,-12],m,e=this.ap(d,a),g=0;g<c.length;g++)m=c[g],m=e+m,0>this.squares[m]||b.push(this.apToName(m));return b},getPawnOptions:function(d,a){for(var b=[],c=n.isWhite(this.getPiece(d,a))?[-11,-9]:[11,9],m,e=this.ap(d,a),g=0;g<c.length;g++)m=c[g],m=e+m,0>this.squares[m]||b.push(this.apToName(m));return b},dump:function(){console.log("-----------------");for(var d=8;0<d;d--){for(var a="|",b=1;9>b;b++)a=this.hasPiece(b,d)?a+this.getPiece(b,d):a+" ",a+="|";console.log(a);console.log("-----------------")}}};
BoardFactory=function(){return{create:function(){return Object.create(q).init()},getPieceMap:function(){return n},getFileMap:function(){return l},getColorMap:function(){return k}}}()})();
(function(n){n.fn.chessn00b=function(c){c||(c={});if("string"==typeof c&&1==this.length&&this[0].displayboard)switch(c){case "fen":return this[0].displayboard.getFEN();default:return"unsupported option"}return this.each(function(){if(!this.displayboard){var a="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";c.fen&&(a=c.fen);c.element=n(this);this.displayboard=Object.create(b).init(c);this.displayboard.setFEN(a)}})};var l=BoardFactory.getPieceMap(),k=BoardFactory.getColorMap(),q=BoardFactory.getFileMap(),
d={"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR":["e7e5"],"rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R":["b8c6"],"rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR":["g7g6"]},a={init:function(c){this.square=c;this.element=n('<div class="chessn00b-square">&nbsp;</div>');this.element[0].displaySquare=this;this.element.attr("rel",c.name);this.element.addClass(this.square.color==k.white?
"chessn00b-light-square":"chessn00b-dark-square");return this},lite:function(){this.element.addClass("chessn00b-square-lit")},unlite:function(){this.element.removeClass("chessn00b-square-lit")},toggleLite:function(){this.element.hasClass("chessn00b-square-lit")?this.unlite():this.lite()}},b={init:function(c){if(!c||!c.element)throw Error('Missing options; requires at least "element" to attach to.');"undefined"===typeof c.playGame&&(c.playGame=!0);c.displayGameScore=!1;"undefined"===typeof c.gameScoreSelector?
c.displayGameScore=!1:"string"===typeof c.gameScoreSelector&&(this.gameScoreElement=n(c.gameScoreSelector),0<this.gameScoreElement.length&&(c.displayGameScore=!0));"undefined"===typeof c.notationType&&(c.notationType="SAN");"boolean"!==typeof c.coordinates&&(c.coordinates=!1);this.element=c.element;this.board=BoardFactory.create();this.engine=EngineFactory.create(this.board);this.playGame=c.playGame;this.lastClickedSquare=null;this.displaySquares=[];this.thinking=!1;this.options=c;this.gameScore=
"";this.currentPieceCount=this.board.getPieceCount();this.id="board"+Math.floor(1E6*Math.random());this.element.addClass(this.id);for(c=1;9>c;c++)for(var b=1;9>b;b++)1==b&&(this.displaySquares[c]=[]),this.displaySquares[c][b]=Object.create(a).init({file:c,rank:b,color:this.board.getSquareColor(c,b),name:q.name(c,b)});this.createDisplay();return this},createDisplay:function(){this.element.append('<div class="chessn00b-outer-board"><div class="chessn00b-inner-board"></div></div>');for(var c=this.element.find(".chessn00b-inner-board"),
a=this.element.find(".chessn00b-outer-board"),b=8;0<b;b--){for(var d=n('<div class="chessn00b-rank" rel="'+b+'"></div>'),f=1;9>f;f++)d.append(this.displaySquares[f][b].element);c.append(d)}if(this.options.coordinates){c=n('<div class="chessn00b-file-markers"></div>');for(f=1;9>f;f++)c.append('<div class="chessn00b-file-marker">'+q[f]+"</div>");f=n('<div class="chessn00b-rank-markers"></div>');for(b=8;0<b;b--)f.append('<div class="chessn00b-rank-marker">'+b+"</div>");a.append(f);a.append(c)}this.element.append('<div class="chessn00b-status"><span class="illegal-move">Illegal move. </span><span class="your-move">Your move</span><span class="game-over">Game Over. </span><span class="you-win">You win!</span><span class="you-lose">You lose!</span><span class="draw">Draw.</span><span class="thinking">Thinking...</span></div>');
this.element.find(".illegal-move").hide();this.element.find(".thinking").hide();this.element.find(".game-over").hide();this.element.find(".you-lose").hide();this.element.find(".you-win").hide();this.element.find(".draw").hide();this.element.append('<div class="chessn00b-promote"><a href="#" class="chessn00b-square promote-white" rel="Q">'+l.Q+'</a><a href="#" class="chessn00b-square promote-black" rel="q">'+l.q+'</a><a href="#" class="chessn00b-square promote-white" rel="R">'+l.R+'</a><a href="#" class="chessn00b-square promote-black" rel="r">'+
l.r+'</a><a href="#" class="chessn00b-square promote-white" rel="B">'+l.B+'</a><a href="#" class="chessn00b-square promote-black" rel="b">'+l.b+'</a><a href="#" class="chessn00b-square promote-white" rel="N">'+l.N+'</a><a href="#" class="chessn00b-square promote-black" rel="n">'+l.n+"</a></div>");this.element.append('<div class="chessn00b-animator chessn00b-square"></div>');this.playGame||this.element.find(".your-move").hide();this.autosetHeight();var h=this;this.element.on("click",".chessn00b-rank .chessn00b-square",
function(){h.squareClicked(n(this));return!1})},autosetHeight:function(){var c=Math.ceil(this.element.width()/9);"undefined"==typeof this.dynCSS&&(this.dynCSS=document.createElement("style"),document.getElementsByTagName("head")[0].appendChild(this.dynCSS));var a="."+this.id+" .chessn00b-inner-board, .chessn00b-file-markers { width: "+8*c+"px; }",a=a+("."+this.id+" .chessn00b-square { font-size: "+Math.ceil(.82*c)+"px;  height: "+c+"px;  line-height: "+c+"px; }"),a=a+("."+this.id+" .chessn00b-rank-marker { height: "+
c+"px;  line-height: "+c+"px; }"),a=a+("."+this.id+" .chessn00b-promote {  top: -"+Math.ceil(5*c)+"px; left: "+Math.ceil(2.2*c)+"px; }"),a=a+("."+this.id+" .chessn00b-animator {  width: "+c+"px; }");this.dynCSS.styleSheet?this.dynCSS.styleSheet.cssText=a:this.dynCSS.innerHTML=a},squareClicked:function(a){if(!this.thinking)if(this.element.find(".illegal-move").hide(),this.lastClickedSquare)if(a[0]==this.lastClickedSquare)this.lastClickedSquare.displaySquare.unlite(),this.lastClickedSquare=null;else{this.lastClickedSquare.displaySquare.unlite();
var b=""+this.lastClickedSquare.displaySquare.square.name+a[0].displaySquare.square.name,e=this,d=function(){e.engine.isValidMove(b)?(e.engine.move(b),e.update(b),e.lastClickedSquare=null,e.playGame&&e.autoMove()):(e.element.find(".illegal-move").show(),e.lastClickedSquare=null)};this.engine.isPromotionPossible(b)?(this.element.find(".chessn00b-promote").css("display","inline-block"),this.element.find(".chessn00b-promote .promote-white").show(),this.element.find(".chessn00b-promote .promote-black").hide(),
this.element.on("click.promote","a",function(){e.element.off("click.promote");e.element.find(".chessn00b-promote").hide();b+=n(this).attr("rel");d();return!1})):d()}else a[0].displaySquare.lite(),this.lastClickedSquare=a[0]},autoMove:function(){this.thinking=!0;this.element.find(".your-move").hide();this.element.find(".thinking").show();var a=this;setTimeout(function(){var b;b=a.engine.blackInCheckmate();var e=a.engine.inStalemate(!1);b||e?(a.thinking=!1,a.element.find(".thinking").hide(),a.element.find(".game-over").show(),
b?a.element.find(".you-win").show():a.element.find(".draw").show()):((b=d[a.getFEN()])?(b=b[Math.round(Math.random()*(b.length-1))],console.log("book move used")):b=a.engine.getBestMoveForBlack(),a.engine.move(b),a.animate(b),a.thinking=!1,a.element.find(".thinking").hide(),b=a.engine.whiteInCheckmate(),e=a.engine.inStalemate(!0),b||e?(a.element.find(".game-over").show(),b?a.element.find(".you-lose").show():a.element.find(".draw").show()):a.element.find(".your-move").show())},20)},setFEN:function(a){this.board.setFEN(a);
this.update()},getFEN:function(){return this.engine.getPositionFEN()},update:function(a){this.updateDisplayBoard();"undefined"!==typeof a&&this.updateGameScore(a)},updateDisplayBoard:function(){for(var a=1;9>a;a++)for(var b=1;9>b;b++)this.board.hasPiece(a,b)?this.displaySquares[a][b].element.html(l[this.board.getPiece(a,b)]):this.displaySquares[a][b].element.html("&nbsp;")},updateGameScore:function(a){var b=this.board.getPieceCount(),e=!1;b<this.currentPieceCount&&(e=!0);this.currentPieceCount=b;
b="";this.board.colorToMove!=k.white&&(b+=""+this.board.fullMoveNumber+". ");b+=this.convertNotation(a,e);this.board.colorToMove==k.white&&this.engine.whiteInCheck()?b+="+":this.board.colorToMove==k.black&&this.engine.blackInCheck()&&(b+="+");this.gameScore+=b+" ";this.options.displayGameScore&&this.gameScoreElement.html(this.gameScore)},convertNotation:function(a,b){var e=q.coords(a.substr(0,2)),d=q.coords(a.substr(2,2)),f=a.substr(2,3),h=this.board.getPiece(d.file,d.rank);"p"==h||"P"==h?e=b?a.substr(0,
1)+"x"+f:f:"k"!=h&&"K"!=h||2!=Math.abs(e.file-d.file)?(e="FAN"==this.options.notationType?l[h]:h.toUpperCase(),b&&(e+="x"),e+=f):e=e.file<d.file?"O-O":"O-O-O";return e},animate:function(a){var b=q.coords(a.substr(0,2)),e=q.coords(a.substr(2,2)),d=this.displaySquares[e.file][e.rank].element.offset(),f=this.element.find(".chessn00b-animator"),h=this.displaySquares[b.file][b.rank].element.offset();f.html(l[this.board.getPiece(e.file,e.rank)]);this.displaySquares[b.file][b.rank].element.html("&nbsp;");
var k=this;f.css("top",h.top+"px").css("left",h.left+"px").css("display","block").animate({left:d.left,top:d.top},400,function(){f.css("display","none");k.update(a)})}}})(jQuery);if("undefined"===typeof BoardFactory)throw console&&console.log("Missing the BoardFactory!"),Error("Missing the BoardFactory!");var EngineFactory;
(function(){var n=BoardFactory.getPieceMap(),l=BoardFactory.getColorMap(),k=BoardFactory.getFileMap(),q={init:function(a){this.board=a;this.searchPly=3;this.resetCaches();return this},resetCaches:function(){this.whiteCoveredSquares=[];this.blackCoveredSquares=[];this.blackDynamicValue=this.whiteDynamicValue=this.blackStaticValue=this.whiteStaticValue=0;this.cachedPositionFEN=null;this.validWhiteMoves=[];this.validBlackMoves=[]},getWhitesCoveredSquares:function(){this.determineCoveredSquares(!0);return this.whiteCoveredSquares},
getBlacksCoveredSquares:function(){this.determineCoveredSquares(!1);return this.blackCoveredSquares},getValidMovesForWhite:function(){this.determineValidMoves(!0);return this.validWhiteMoves},getValidMovesForBlack:function(){this.determineValidMoves(!1);return this.validBlackMoves},getValidMovesFor:function(a){this.determineValidMoves(a);return a?this.validWhiteMoves:this.validBlackMoves},determineValidMoves:function(a){if(!(a&&0<this.validWhiteMoves.length||!a&&0<this.validBlackMoves.length)){a&&
(this.validWhiteMoves=[]);a||(this.validBlackMoves=[]);for(var b,c,d,e,g=1;9>g;g++)for(var f=1;9>f;f++)if(this.board.hasPiece(g,f)&&(b=k.name(g,f),d=n.isWhite(this.board.getPiece(g,f)),d==a)){e=this.getValidMovesForSquare(g,f);for(var h=0;h<e.length;h++)c=""+b+e[h],d?this.validWhiteMoves.push(c):this.validBlackMoves.push(c)}}},getValidMovesForSquare:function(a,b){var c=[];if(!this.board.hasPiece(a,b))return c;var d=this.board.getPiece(a,b),e=n.isWhite(d),g="k"==d||"K"==d?!0:!1,f="p"==d||"P"==d?!0:
!1,d=k.name(a,b);this.getPositionFEN();var h=EngineFactory.create(),p=this.board.getCoveredSquares(a,b);if(0==p.length)return c;for(var l,q,t,r=0;r<p.length;r++)l=k[p[r].substr(0,1)],q=p[r].substr(1,1),t=this.board.hasPiece(l,q),l=this.board.getPiece(l,q),t&&n.isWhite(l)==e||f&&!t||(h.setFromBoard(this.board),t=""+d+p[r],h.move(t,!0),e&&h.whiteInCheck()||!e&&h.blackInCheck()||(f?e&&8==q?(c.push(p[r]+"Q"),c.push(p[r]+"R"),c.push(p[r]+"B"),c.push(p[r]+"N")):e||1!=q?c.push(p[r]):(c.push(p[r]+"q"),c.push(p[r]+
"r"),c.push(p[r]+"b"),c.push(p[r]+"n")):c.push(p[r])));f&&(e?8>b&&!this.board.hasPiece(a,b+1)&&(h.setFromBoard(this.board),t=""+d+k.name(a,b+1),h.move(t,!0),h.whiteInCheck()||(7>b?c.push(k.name(a,b+1)):(f=k.name(a,b+1),c.push(f+"Q"),c.push(f+"R"),c.push(f+"N"),c.push(f+"B"))),2!=b||this.board.hasPiece(a,b+2)||(h.setFromBoard(this.board),t=""+d+k.name(a,b+2),h.move(t,!0),h.whiteInCheck()||c.push(k.name(a,b+2)))):1<b&&!this.board.hasPiece(a,b-1)&&(h.setFromBoard(this.board),t=""+d+k.name(a,b-1),h.move(t,
!0),h.blackInCheck()||(2<b?c.push(k.name(a,b-1)):(f=k.name(a,b-1),c.push(f+"q"),c.push(f+"r"),c.push(f+"n"),c.push(f+"b"))),7!=b||this.board.hasPiece(a,b-2)||(h.setFromBoard(this.board),t=""+d+k.name(a,b-2),h.move(t,!0),h.blackInCheck()||c.push(k.name(a,b-2)))));g&&(e&&!this.whiteInCheck()&&1==b?(!(0<=this.board.castlingOptions.indexOf("K"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByBlack(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByBlack(a+2,b)||c.push(k.name(a+2,b)),!(0<=
this.board.castlingOptions.indexOf("Q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByBlack(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByBlack(a-2,b)||c.push(k.name(a-2,b))):e||this.blackInCheck()||8!=b||(!(0<=this.board.castlingOptions.indexOf("k"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByWhite(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByWhite(a+2,b)||c.push(k.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByWhite(a-
1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByWhite(a-2,b)||c.push(k.name(a-2,b))));return c},isPromotionPossible:function(a){a=k.coords(a.substr(0,2));if(this.board.hasPiece(a.file,a.rank)){var b=this.board.getPiece(a.file,a.rank);if("p"==b&&2==a.rank||"P"==b&&7==a.rank)return!0}return!1},isValidMove:function(a,b){var c,d;c="object"==typeof a?a:k.coords(a.substr(0,2));d="object"==typeof b?k.name(b.file,b.rank):a.substr(2,3);if(!this.board.hasPiece(c.file,c.rank)||n.getColor(this.board.getPiece(c.file,
c.rank))!=this.board.getColorToMove())return!1;c=this.getValidMovesForSquare(c.file,c.rank);for(var e=0;e<c.length;e++)if(c[e]===d)return!0;return!1},determineCoveredSquares:function(a){if(!(a&&0<this.whiteCoveredSquares.length||!a&&0<this.blackCoveredSquares.legnth)){a&&(this.whiteCoveredSquares=[]);a||(this.blackCoveredSquares=[]);for(var b,c=1;9>c;c++)for(var d=1;9>d;d++)if(this.board.hasPiece(c,d)){var e=n.isWhite(this.board.getPiece(c,d));if(e==a){b=this.board.getCoveredSquares(c,d);var g=this.blackCoveredSquares;
e&&(g=this.whiteCoveredSquares);for(e=0;e<b.length;e++)g.push(b[e])}}}},findPiece:function(a){for(var b=[],c=1;9>c;c++)for(var d=1;9>d;d++)this.board.hasPiece(c,d)&&this.board.getPiece(c,d)==a&&b.push({file:c,rank:d});return b},isSquareAttacked:function(a,b){if(!this.board.hasPiece(a,b))return!1;var c=k.name(a,b),d;d=n.isWhite(this.board.getPiece(a,b))?this.getBlacksCoveredSquares():this.getWhitesCoveredSquares();for(var e=0;e<d.length;e++)if(d[e]==c)return!0;return!1},isSquareAttackedByWhite:function(a,
b){for(var c=k.name(a,b),d=this.getWhitesCoveredSquares(),e=0;e<d.length;e++)if(d[e]==c)return!0;return!1},isSquareAttackedByBlack:function(a,b){for(var c=k.name(a,b),d=this.getBlacksCoveredSquares(),e=0;e<d.length;e++)if(d[e]==c)return!0;return!1},getPositionFEN:function(){if(this.cachedPositionFEN)return this.cachedPositionFEN;for(var a=[],b=8;0<b;b--){for(var c="",d=0,e=1;9>e;e++)this.board.hasPiece(e,b)?(0<d&&(c+=d,d=0),c+=this.board.getPiece(e,b)):d++;0<d&&(c+=d);a.push(c)}return this.cachedPositionFEN=
a.join("/")},setFEN:function(a){this.resetCaches();this.board.setFEN(a)},setFromBoard:function(a){this.resetCaches();this.board.copyFrom(a)},inStalemate:function(a){return this.inCheck(a)?!1:0==this.getValidMovesFor(a).length?!0:!1},inCheck:function(a){a=this.findPiece(a?"K":"k");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)},blackInCheck:function(){return this.inCheck(!1)},whiteInCheck:function(){return this.inCheck(!0)},inCheckmate:function(a){return this.inCheck(a)?0==this.getValidMovesFor(a).length?
!0:!1:!1},blackInCheckmate:function(){return this.inCheckmate(!1)},whiteInCheckmate:function(){return this.inCheckmate(!0)},moves:function(a){"string"==typeof a&&(a=a.split(" "));for(var b=0;b<a.length;b++)if(!this.move(a[b]))return!1;return!0},move:function(a,b){var c,d;b=!0===b?!0:!1;var e=k.coords(a.substr(0,2)),g=k.coords(a.substr(2,2)),f=null;4<a.length&&(f=a.substr(4,1));if(!this.board.hasPiece(e.file,e.rank)||!b&&!this.isValidMove(a))return!1;var h=this.board.getPiece(e.file,e.rank);this.board.removePiece(e.file,
e.rank);this.board.setPiece(h,g.file,g.rank);if((c="k"==h||"K"==h?!0:!1)&&2==Math.abs(e.file-g.file)){var p;g.file>e.file?(p={file:g.file+1,rank:g.rank},c=g.file-1):(p={file:g.file-2,rank:g.rank},c=g.file+1);d=g.rank;var l=this.board.getPiece(p.file,p.rank);l||(console.log(e),console.log(g),console.log(p),this.board.dump());this.board.removePiece(p.file,p.rank);this.board.setPiece(l,c,d);n.isWhite(l)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=
this.board.castlingOptions.replace(/[kq]/g,"");""==this.board.castlingOptions&&(this.board.castlingOptions="-")}else c&&(n.isWhite(h)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=this.board.castlingOptions.replace(/[kq]/g,""));"r"==h?1==e.file?this.board.castlingOptions=this.board.castlingOptions.replace("q",""):8==e.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("k","")):"R"==h&&(1==e.file?this.board.castlingOptions=this.board.castlingOptions.replace("Q",
""):8==e.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("K","")));f&&this.board.setPiece(f,g.file,g.rank);this.board.incrementMove();this.resetCaches();return!0},getWhiteStaticValue:function(){this.determineStaticValues();return this.whiteStaticValue},getBlackStaticValue:function(){this.determineStaticValues();return this.blackStaticValue},determineStaticValues:function(){if(!(0<this.whiteStaticValue||0<this.blackStaticValue)){this.blackStaticValue=this.whiteStaticValue=0;for(var a,
b=1;9>b;b++)for(var c=1;9>c;c++)if(this.board.hasPiece(b,c)){switch(this.board.getPiece(b,c)){case "Q":case "q":a=9.75;break;case "R":case "r":a=5;break;case "B":case "b":a=3.25;break;case "N":case "n":a=3.25;break;case "P":case "p":a=1;break;default:continue}a*=10;n.isWhite(this.board.getPiece(b,c))?this.whiteStaticValue+=a:this.blackStaticValue+=a}}},getWhiteDynamicValue:function(){this.determineDynamicValues();return this.whiteDynamicValue},getBlackDynamicValue:function(){this.determineDynamicValues();
return this.blackDynamicValue},determineDynamicValues:function(){if(!(0<this.whiteDynamicValue||0<this.blackDynamicValue)){this.blackDynamicValue=this.whiteDynamicValue=0;2<=this.findPiece("b").length&&(this.blackDynamicValue+=5);2<=this.findPiece("B").length&&(this.whiteDynamicValue+=5);var a=this.getBlacksCoveredSquares();this.blackDynamicValue+=Math.round(a.length/2);a=this.getWhitesCoveredSquares();this.whiteDynamicValue+=Math.round(a.length/2)}},getBestMoveForWhite:function(){return this.getBestMove(!0)},
getBestMoveForBlack:function(){return this.getBestMove(!1)},getBestMoveSimple:function(a){for(var b=[],c=1;9>c;c++)for(var d=1;9>d;d++)if(this.board.hasPiece(c,d)&&n.isWhite(this.board.getPiece(c,d))==a){var e=this.getValidMovesForSquare(c,d);if(0!=e.length)for(var g=0;g<e.length;g++){var f=""+k.name(c,d)+e[g].name,h=this.evaluateMove(f);if(1E3==Math.abs(h))return f;b.push({move:f,value:h})}}c=function(a,b){return a.value-b.value};a&&(c=function(a,b){return b.value-a.value});b.sort(c);if(this.mark)for(g=
0;g<b.length;g++)console.log(b[g].move+": "+b[g].value);return b[0].move},evaluateMove:function(a){var b=this.clone();b.move(a);return b.evaluatePosition()},clone:function(){var a=EngineFactory.create();a.setFromBoard(this.board);return a}},d;q.getBestMove=function(a){this.lastBestMove="";d=this.lastValue=0;var b=(new Date).getTime();this.alphabeta(this.searchPly,-1E4,1E4,a);b=((new Date).getTime()-b)/1E3;console.log((a?"white":"black")+" to move; examined: "+d+" nodes in "+b+"s ("+Math.round(d/b)+
"n/s); best: "+this.lastBestMove+" ("+this.lastValue+")");return this.lastBestMove};q.alphabetaNew=function(a,b,c,k){d++;if(0==a)return this.evaluatePosition();var e=this.getValidMovesFor(k),g=e.length;if(0==g)return this.evaluatePosition();for(var f,h=0;h<g;h++){f=this.clone();f.move(e[h]);f=f.alphabeta(a-1,b,c,!k);if(k){if(b<f&&(b=f,this.lastBestMove=e[h],this.lastValue=f,1E3==f))break}else if(c>f&&(c=f,this.lastBestMove=e[h],this.lastValue=f,-1E3==f))break;if(c<=b)break}return k?c:b};q.alphabeta=
function(a,b,c,k){d++;var e;if(0==a)return this.evaluatePosition();var g=this.clone(),f;if(k){f=this.getValidMovesForWhite();for(var h=0;h<f.length;h++){g.setFromBoard(this.board);g.move(f[h]);if(g.blackInCheckmate()){b=1E3;this.lastBestMove=f[h];this.lastValue=b;break}e=g.alphabeta(a-1,b,c,!k);b<e&&(b=e,this.lastBestMove=f[h],this.lastValue=e);if(c<=b)break}return b}f=this.getValidMovesForBlack();for(h=0;h<f.length;h++){g.setFromBoard(this.board);g.move(f[h]);5==a&&g.board.dump();if(g.whiteInCheckmate()){c=
-1E3;this.lastBestMove=f[h];this.lastValue=c;break}e=g.alphabeta(a-1,b,c,!k);c>e&&(c=e,this.lastBestMove=f[h],this.lastValue=c);if(c<=b)break}return c};q.evaluatePosition=function(){if(this.whiteInCheckmate())return-1E3;if(this.blackInCheckmate())return 1E3;var a=0,b=this.board.getColorToMove()==l.white?!0:!1;if(this.inStalemate(b))return a;a+=this.getWhiteStaticValue();a-=this.getBlackStaticValue();a+=this.getWhiteDynamicValue();return a-=this.getBlackDynamicValue()};EngineFactory=function(){return{create:function(a){"undefined"===
typeof a&&(a=BoardFactory.create());return Object.create(q).init(a)}}}()})();
