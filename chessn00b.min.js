var BoardFactory;
(function(){"function"!==typeof Object.create&&(Object.create=function(c){function e(){}e.prototype=c;return new e});var p={R:"\u2656",N:"\u2658",B:"\u2657",Q:"\u2655",K:"\u2654",P:"\u2659",r:"\u265c",n:"\u265e",b:"\u265d",q:"\u265b",k:"\u265a",p:"\u265f",isWhite:function(c){if("string"!=typeof c)throw Error('Got a non-string piece "'+c+'"');return 91>c.charCodeAt(0)?!0:!1},getColor:function(c){return this.isWhite(c)?g.white:g.black}},n={1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",a:"1",b:"2",
c:"3",d:"4",e:"5",f:"6",g:"7",h:"8",name:function(c,e){return n[c]+e},coords:function(c){return{file:parseInt(n[c.substr(0,1)],10),rank:parseInt(c.substr(1,1),10)}}},g={white:8,black:0},q={init:function(){this.colorToMove=g.white;this.enpassantTarget=this.castlingOptions="-";this.fullMoveNumber=this.halfMoveClock=0;this.squares=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,
-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];this.squareColors=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];return this},copyFrom:function(c){this.squares=c.squares.slice();
this.colorToMove=c.colorToMove;this.castlingOptions=c.castlingOptions;this.enpassantTarget=c.enpassantTarget;this.haveMoveClock=c.halfMoveClock;this.fullMoveNumber=c.fullMoveNumber},setFEN:function(c){c=c.split(" ");for(var e=c[0].split("/"),a=8;0<a;a--)this.setRankFEN(a,e[8-a]);this.colorToMove="w"==c[1]?g.white:g.black;c[2]&&(this.castlingOptions=c[2]);c[3]&&(this.enpassantTarget=c[3]);"undefined"!=typeof c[4]&&(this.halfMoveClock=parseInt(c[4],10));"undefined"!=typeof c[5]&&(this.fullMoveNumber=
parseInt(c[5],10))},setRankFEN:function(c,e){var a=e.split(""),b=1,d;for(d in a){if(8<b||" "==a[d])break;if(p[a[d]])this.setPiece(a[d],b,c),b++;else for(;0<a[d];)this.removePiece(b,c),a[d]--,b++}},getColorToMove:function(){return this.colorToMove},incrementMove:function(){this.colorToMove==g.white?this.colorToMove=g.black:(this.colorToMove=g.white,this.fullMoveNumber++)},ap:function(c,e){return 10*(10-parseInt(e,10))+parseInt(c,10)},apToName:function(c){return n.name(c%10,10-Math.floor(c/10))},setPiece:function(c,
e,a){this.squares[this.ap(e,a)]=c},removePiece:function(c,e){this.squares[this.ap(c,e)]=0},hasPiece:function(c,e){var a;a="undefined"===typeof e?c:this.ap(c,e);return"string"===typeof this.squares[a]?!0:!1},getPiece:function(c,e){return this.squares[this.ap(c,e)]},getPieceCount:function(){for(var c=0,e=8;0<e;e--)for(var a=1;9>a;a++)this.hasPiece(a,e)&&c++;return c},getSquareColor:function(c,e){"undefined"==typeof e&&"string"==typeof c&&(e=c.substr(1,1),c=n[c.substr(0,1)]);return this.squareColors[this.ap(c,
e)]},getCoveredSquares:function(c,e){var a=[],b=[];switch(this.getPiece(c,e)){case "K":case "k":a=this.getStraightOptions(c,e,1);b=this.getDiagonalOptions(c,e,1);break;case "Q":case "q":a=this.getStraightOptions(c,e,8);b=this.getDiagonalOptions(c,e,8);break;case "R":case "r":a=this.getStraightOptions(c,e,8);break;case "B":case "b":b=this.getDiagonalOptions(c,e,8);break;case "N":case "n":a=this.getKnightOptions(c,e);break;case "P":case "p":a=this.getPawnOptions(c,e)}for(var d=0;d<b.length;d++)a.push(b[d]);
return a},getStraightOptions:function(c,e,a){for(var b=[],d=[-1,-10,1,10],h=this.ap(c,e),f,u=0;u<d.length;u++)for(e=d[u],f=h,c=0;c<a;){f+=e;if(0>this.squares[f])break;b.push(this.apToName(f));if(this.hasPiece(f))break;c++}return b},getDiagonalOptions:function(c,e,a){for(var b=[],d=[-11,-9,9,11],h=this.ap(c,e),f,u=0;u<d.length;u++)for(e=d[u],f=h,c=0;c<a;){f+=e;if(0>this.squares[f])break;b.push(this.apToName(f));if(this.hasPiece(f))break;c++}return b},getKnightOptions:function(c,e){for(var a=[],b=[-21,
-19,-8,12,21,19,8,-12],d,h=this.ap(c,e),f=0;f<b.length;f++)d=b[f],d=h+d,0>this.squares[d]||a.push(this.apToName(d));return a},getPawnOptions:function(c,e){for(var a=[],b=p.isWhite(this.getPiece(c,e))?[-11,-9]:[11,9],d,h=this.ap(c,e),f=0;f<b.length;f++)d=b[f],d=h+d,0>this.squares[d]||a.push(this.apToName(d));return a},dump:function(){console.log("-----------------");for(var c=8;0<c;c--){for(var e="|",a=1;9>a;a++)e=this.hasPiece(a,c)?e+this.getPiece(a,c):e+" ",e+="|";console.log(e);console.log("-----------------")}}};
BoardFactory=function(){return{create:function(){return Object.create(q).init()},getPieceMap:function(){return p},getFileMap:function(){return n},getColorMap:function(){return g}}}()})();
(function(p){p.fn.chessn00b=function(b){b||(b={});if("string"==typeof b&&1==this.length&&this[0].displayboard)switch(b){case "fen":return this[0].displayboard.getFEN();default:return"unsupported option"}return this.each(function(){if(!this.displayboard){var d="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";b.fen&&(d=b.fen);b.element=p(this);this.displayboard=Object.create(a).init(b);this.displayboard.setFEN(d)}})};var n=BoardFactory.getPieceMap(),g=BoardFactory.getColorMap(),q=BoardFactory.getFileMap(),
c={"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR":["e7e5"],"rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R":["b8c6"],"rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR":["g7g6"]},e={init:function(b){this.square=b;this.element=p('<div class="chessn00b-square">&nbsp;</div>');this.element[0].displaySquare=this;this.element.attr("rel",b.name);this.element.addClass(this.square.color==g.white?
"chessn00b-light-square":"chessn00b-dark-square");return this},lite:function(){this.element.addClass("chessn00b-square-lit")},unlite:function(){this.element.removeClass("chessn00b-square-lit")},toggleLite:function(){this.element.hasClass("chessn00b-square-lit")?this.unlite():this.lite()}},a={init:function(b){if(!b||!b.element)throw Error('Missing options; requires at least "element" to attach to.');"undefined"===typeof b.playGame&&(b.playGame=!0);b.displayGameScore=!1;"undefined"===typeof b.gameScoreSelector?
b.displayGameScore=!1:"string"===typeof b.gameScoreSelector&&(this.gameScoreElement=p(b.gameScoreSelector),0<this.gameScoreElement.length&&(b.displayGameScore=!0));"undefined"===typeof b.notationType&&(b.notationType="SAN");this.element=b.element;this.board=BoardFactory.create();this.engine=EngineFactory.create(this.board);this.playGame=b.playGame;this.lastClickedSquare=null;this.displaySquares=[];this.thinking=!1;this.options=b;this.gameScore="";this.currentPieceCount=this.board.getPieceCount();
this.id="board"+Math.floor(1E6*Math.random());this.element.addClass(this.id);for(b=1;9>b;b++)for(var a=1;9>a;a++)1==a&&(this.displaySquares[b]=[]),this.displaySquares[b][a]=Object.create(e).init({file:b,rank:a,color:this.board.getSquareColor(b,a),name:q.name(b,a)});this.createDisplay();return this},createDisplay:function(){for(var b=8;0<b;b--){for(var a=p('<div class="chessn00b-rank" rel="'+b+'"></div>'),h=1;9>h;h++)a.append(this.displaySquares[h][b].element);this.element.append(a)}this.element.append('<div class="chessn00b-status"><span class="illegal-move">Illegal move. </span><span class="your-move">Your move</span><span class="game-over">Game Over. </span><span class="you-win">You win!</span><span class="you-lose">You win!</span><span class="thinking">Thinking...</span></div>');
this.element.find(".illegal-move").hide();this.element.find(".thinking").hide();this.element.find(".game-over").hide();this.element.find(".you-lose").hide();this.element.find(".you-win").hide();this.element.append('<div class="chessn00b-promote"><a href="#" class="chessn00b-square promote-white" rel="Q">'+n.Q+'</a><a href="#" class="chessn00b-square promote-black" rel="q">'+n.q+'</a><a href="#" class="chessn00b-square promote-white" rel="R">'+n.R+'</a><a href="#" class="chessn00b-square promote-black" rel="r">'+
n.r+'</a><a href="#" class="chessn00b-square promote-white" rel="B">'+n.B+'</a><a href="#" class="chessn00b-square promote-black" rel="b">'+n.b+'</a><a href="#" class="chessn00b-square promote-white" rel="N">'+n.N+'</a><a href="#" class="chessn00b-square promote-black" rel="n">'+n.n+"</a></div>");this.element.append('<div class="chessn00b-animator chessn00b-square"></div>');this.playGame||this.element.find(".your-move").hide();this.autosetHeight();var f=this;this.element.on("click",".chessn00b-rank .chessn00b-square",
function(){f.squareClicked(p(this));return!1})},autosetHeight:function(){var b=this.displaySquares[1][1].element.width();"undefined"==typeof this.dynCSS&&(this.dynCSS=document.createElement("style"),document.getElementsByTagName("head")[0].appendChild(this.dynCSS));var a="."+this.id+" .chessn00b-square { font-size: "+Math.ceil(.82*b)+"px;  height: "+b+"px;  line-height: "+b+"px; }",a=a+("."+this.id+" .chessn00b-promote {  top: -"+Math.ceil(5*b)+"px; left: "+Math.ceil(2.2*b)+"px; }"),a=a+("."+this.id+
" .chessn00b-animator {  width: "+b+"px; }");this.dynCSS.styleSheet?this.dynCSS.styleSheet.cssText=a:this.dynCSS.innerHTML=a},squareClicked:function(b){if(!this.thinking)if(this.element.find(".illegal-move").hide(),this.lastClickedSquare)if(b[0]==this.lastClickedSquare)this.lastClickedSquare.displaySquare.unlite(),this.lastClickedSquare=null;else{this.lastClickedSquare.displaySquare.unlite();var a=""+this.lastClickedSquare.displaySquare.square.name+b[0].displaySquare.square.name,h=this,f=function(){h.engine.isValidMove(a)?
(h.engine.move(a),h.update(a),h.lastClickedSquare=null,h.playGame&&h.autoMove()):(h.element.find(".illegal-move").show(),h.lastClickedSquare=null)};this.engine.isPromotionPossible(a)?(this.element.find(".chessn00b-promote").css("display","inline-block"),this.element.find(".chessn00b-promote .promote-white").show(),this.element.find(".chessn00b-promote .promote-black").hide(),this.element.on("click.promote","a",function(){h.element.off("click.promote");h.element.find(".chessn00b-promote").hide();a+=
p(this).attr("rel");f();return!1})):f()}else b[0].displaySquare.lite(),this.lastClickedSquare=b[0]},autoMove:function(){this.thinking=!0;this.element.find(".your-move").hide();this.element.find(".thinking").show();var b=this;setTimeout(function(){var a;b.engine.blackInCheckmate()?(b.thinking=!1,b.element.find(".thinking").hide(),b.element.find(".game-over").show(),b.element.find(".you-win").show()):((a=c[b.getFEN()])?(a=a[Math.round(Math.random()*(a.length-1))],console.log("book move used")):a=b.engine.getBestMoveForBlack(),
b.engine.move(a),b.animate(a),b.thinking=!1,b.element.find(".thinking").hide(),b.engine.whiteInCheckmate()?(b.element.find(".game-over").show(),b.element.find(".you-lose").show()):b.element.find(".your-move").show())},20)},setFEN:function(b){this.board.setFEN(b);this.update()},getFEN:function(){return this.engine.getPositionFEN()},update:function(b){this.updateDisplayBoard();"undefined"!==typeof b&&this.updateGameScore(b)},updateDisplayBoard:function(){for(var b=1;9>b;b++)for(var a=1;9>a;a++)this.board.hasPiece(b,
a)?this.displaySquares[b][a].element.html(n[this.board.getPiece(b,a)]):this.displaySquares[b][a].element.html("&nbsp;")},updateGameScore:function(a){var d=this.board.getPieceCount(),h=!1;d<this.currentPieceCount&&(h=!0);this.currentPieceCount=d;d="";this.board.colorToMove!=g.white&&(d+=""+this.board.fullMoveNumber+". ");d+=this.convertNotation(a,h);this.board.colorToMove==g.white&&this.engine.whiteInCheck()?d+="+":this.board.colorToMove==g.black&&this.engine.blackInCheck()&&(d+="+");this.gameScore+=
d+" ";this.options.displayGameScore&&this.gameScoreElement.html(this.gameScore)},convertNotation:function(a,d){var h=q.coords(a.substr(0,2)),f=q.coords(a.substr(2,2)),c=a.substr(2,3),e=this.board.getPiece(f.file,f.rank);"p"==e||"P"==e?h=d?a.substr(0,1)+"x"+c:c:"k"!=e&&"K"!=e||2!=Math.abs(h.file-f.file)?(h="FAN"==this.options.notationType?n[e]:e.toUpperCase(),d&&(h+="x"),h+=c):h=h.file<f.file?"O-O":"O-O-O";return h},animate:function(a){var d=q.coords(a.substr(0,2)),h=q.coords(a.substr(2,2)),f=this.displaySquares[h.file][h.rank].element.offset(),
c=this.element.find(".chessn00b-animator"),e=this.displaySquares[d.file][d.rank].element.offset();c.html(n[this.board.getPiece(h.file,h.rank)]);this.displaySquares[d.file][d.rank].element.html("&nbsp;");var g=this;c.css("top",e.top+"px").css("left",e.left+"px").css("display","block").animate({left:f.left,top:f.top},400,function(){c.css("display","none");g.update(a)})}}})(jQuery);
if("undefined"===typeof BoardFactory)throw console&&console.log("Missing the BoardFactory!"),Error("Missing the BoardFactory!");var EngineFactory;
(function(){var p=BoardFactory.getPieceMap(),n=BoardFactory.getColorMap(),g=BoardFactory.getFileMap(),q={init:function(a){this.board=a;this.searchPly=3;this.resetCaches();return this},resetCaches:function(){this.whiteCoveredSquares=[];this.blackCoveredSquares=[];this.blackDynamicValue=this.whiteDynamicValue=this.blackStaticValue=this.whiteStaticValue=0;this.cachedPositionFEN=null;this.validWhiteMoves=[];this.validBlackMoves=[]},getWhitesCoveredSquares:function(){this.determineCoveredSquares(!0);return this.whiteCoveredSquares},
getBlacksCoveredSquares:function(){this.determineCoveredSquares(!1);return this.blackCoveredSquares},getValidMovesForWhite:function(){this.determineValidMoves(!0);return this.validWhiteMoves},getValidMovesForBlack:function(){this.determineValidMoves(!1);return this.validBlackMoves},determineValidMoves:function(a){if(!(a&&0<this.validWhiteMoves.length||!a&&0<this.validBlackMoves.length)){a&&(this.validWhiteMoves=[]);a||(this.validBlackMoves=[]);for(var b,d,c,f,e=1;9>e;e++)for(var k=1;9>k;k++)if(this.board.hasPiece(e,
k)&&(b=g.name(e,k),c=p.isWhite(this.board.getPiece(e,k)),c==a)){f=this.getValidMovesForSquare(e,k);for(var l=0;l<f.length;l++)d=""+b+f[l],c?this.validWhiteMoves.push(d):this.validBlackMoves.push(d)}}},getValidMovesForSquare:function(a,b){var d=[];if(!this.board.hasPiece(a,b))return d;var c=this.board.getPiece(a,b),f=p.isWhite(c),e="k"==c||"K"==c?!0:!1,k="p"==c||"P"==c?!0:!1,c=g.name(a,b);this.getPositionFEN();var l=EngineFactory.create(),m=this.board.getCoveredSquares(a,b);if(0==m.length)return d;
for(var n,q,t,r=0;r<m.length;r++)n=g[m[r].substr(0,1)],q=m[r].substr(1,1),t=this.board.hasPiece(n,q),n=this.board.getPiece(n,q),t&&p.isWhite(n)==f||k&&!t||(l.setFromBoard(this.board),t=""+c+m[r],l.move(t,!0),f&&l.whiteInCheck()||!f&&l.blackInCheck()||(k?f&&8==q?(d.push(m[r]+"Q"),d.push(m[r]+"R"),d.push(m[r]+"B"),d.push(m[r]+"N")):f||1!=q?d.push(m[r]):(d.push(m[r]+"q"),d.push(m[r]+"r"),d.push(m[r]+"b"),d.push(m[r]+"n")):d.push(m[r])));k&&(f?8>b&&!this.board.hasPiece(a,b+1)&&(l.setFromBoard(this.board),
t=""+c+g.name(a,b+1),l.move(t,!0),l.whiteInCheck()||(7>b?d.push(g.name(a,b+1)):(k=g.name(a,b+1),d.push(k+"Q"),d.push(k+"R"),d.push(k+"N"),d.push(k+"B"))),2!=b||this.board.hasPiece(a,b+2)||(l.setFromBoard(this.board),t=""+c+g.name(a,b+2),l.move(t,!0),l.whiteInCheck()||d.push(g.name(a,b+2)))):1<b&&!this.board.hasPiece(a,b-1)&&(l.setFromBoard(this.board),t=""+c+g.name(a,b-1),l.move(t,!0),l.blackInCheck()||(2<b?d.push(g.name(a,b-1)):(k=g.name(a,b-1),d.push(k+"q"),d.push(k+"r"),d.push(k+"n"),d.push(k+
"b"))),7!=b||this.board.hasPiece(a,b-2)||(l.setFromBoard(this.board),t=""+c+g.name(a,b-2),l.move(t,!0),l.blackInCheck()||d.push(g.name(a,b-2)))));e&&(f&&!this.whiteInCheck()&&1==b?(!(0<=this.board.castlingOptions.indexOf("K"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByBlack(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByBlack(a+2,b)||d.push(g.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("Q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByBlack(a-1,b)||this.board.hasPiece(a-
2,b)||this.isSquareAttackedByBlack(a-2,b)||d.push(g.name(a-2,b))):f||this.blackInCheck()||8!=b||(!(0<=this.board.castlingOptions.indexOf("k"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByWhite(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByWhite(a+2,b)||d.push(g.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByWhite(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByWhite(a-2,b)||d.push(g.name(a-2,b))));return d},
isPromotionPossible:function(a){a=g.coords(a.substr(0,2));if(this.board.hasPiece(a.file,a.rank)){var b=this.board.getPiece(a.file,a.rank);if("p"==b&&2==a.rank||"P"==b&&7==a.rank)return!0}return!1},isValidMove:function(a,b){var d,c;d="object"==typeof a?a:g.coords(a.substr(0,2));c="object"==typeof b?g.name(b.file,b.rank):a.substr(2,3);if(!this.board.hasPiece(d.file,d.rank)||p.getColor(this.board.getPiece(d.file,d.rank))!=this.board.getColorToMove())return!1;d=this.getValidMovesForSquare(d.file,d.rank);
for(var f=0;f<d.length;f++)if(d[f]===c)return!0;return!1},determineCoveredSquares:function(a){if(!(a&&0<this.whiteCoveredSquares.length||!a&&0<this.blackCoveredSquares.legnth)){a&&(this.whiteCoveredSquares=[]);a||(this.blackCoveredSquares=[]);for(var b,d=1;9>d;d++)for(var c=1;9>c;c++)if(this.board.hasPiece(d,c)){var f=p.isWhite(this.board.getPiece(d,c));if(f==a){b=this.board.getCoveredSquares(d,c);var e=this.blackCoveredSquares;f&&(e=this.whiteCoveredSquares);for(f=0;f<b.length;f++)e.push(b[f])}}}},
findPiece:function(a){for(var b=[],d=1;9>d;d++)for(var c=1;9>c;c++)this.board.hasPiece(d,c)&&this.board.getPiece(d,c)==a&&b.push({file:d,rank:c});return b},isSquareAttacked:function(a,b){if(!this.board.hasPiece(a,b))return!1;var d=g.name(a,b),c;c=p.isWhite(this.board.getPiece(a,b))?this.getBlacksCoveredSquares():this.getWhitesCoveredSquares();for(var f=0;f<c.length;f++)if(c[f]==d)return!0;return!1},isSquareAttackedByWhite:function(a,b){for(var d=g.name(a,b),c=this.getWhitesCoveredSquares(),f=0;f<
c.length;f++)if(c[f]==d)return!0;return!1},isSquareAttackedByBlack:function(a,b){for(var d=g.name(a,b),c=this.getBlacksCoveredSquares(),f=0;f<c.length;f++)if(c[f]==d)return!0;return!1},getPositionFEN:function(){if(this.cachedPositionFEN)return this.cachedPositionFEN;for(var a=[],b=8;0<b;b--){for(var d="",c=0,f=1;9>f;f++)this.board.hasPiece(f,b)?(0<c&&(d+=c,c=0),d+=this.board.getPiece(f,b)):c++;0<c&&(d+=c);a.push(d)}return this.cachedPositionFEN=a.join("/")},setFEN:function(a){this.resetCaches();this.board.setFEN(a)},
setFromBoard:function(a){this.resetCaches();this.board.copyFrom(a)},blackInCheck:function(){var a=this.findPiece("k");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)},whiteInCheck:function(){var a=this.findPiece("K");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)},blackInCheckmate:function(){var a=this.findPiece("k");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)&&0==this.getValidMovesForBlack().length},whiteInCheckmate:function(){var a=this.findPiece("K");
return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)&&0==this.getValidMovesForWhite().length},moves:function(a){"string"==typeof a&&(a=a.split(" "));for(var b=0;b<a.length;b++)if(!this.move(a[b]))return!1;return!0},move:function(a,b){var d,c;b=!0===b?!0:!1;var f=g.coords(a.substr(0,2)),e=g.coords(a.substr(2,2)),k=null;4<a.length&&(k=a.substr(4,1));if(!this.board.hasPiece(f.file,f.rank)||!b&&!this.isValidMove(a))return!1;var l=this.board.getPiece(f.file,f.rank);this.board.removePiece(f.file,
f.rank);this.board.setPiece(l,e.file,e.rank);if((d="k"==l||"K"==l?!0:!1)&&2==Math.abs(f.file-e.file)){var m;e.file>f.file?(m={file:e.file+1,rank:e.rank},d=e.file-1):(m={file:e.file-2,rank:e.rank},d=e.file+1);c=e.rank;var n=this.board.getPiece(m.file,m.rank);n||(console.log(f),console.log(e),console.log(m),this.board.dump());this.board.removePiece(m.file,m.rank);this.board.setPiece(n,d,c);p.isWhite(n)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=
this.board.castlingOptions.replace(/[kq]/g,"");""==this.board.castlingOptions&&(this.board.castlingOptions="-")}else d&&(p.isWhite(l)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=this.board.castlingOptions.replace(/[kq]/g,""));"r"==l?1==f.file?this.board.castlingOptions=this.board.castlingOptions.replace("q",""):8==f.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("k","")):"R"==l&&(1==f.file?this.board.castlingOptions=this.board.castlingOptions.replace("Q",
""):8==f.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("K","")));k&&this.board.setPiece(k,e.file,e.rank);this.board.incrementMove();this.resetCaches();return!0},getWhiteStaticValue:function(){this.determineStaticValues();return this.whiteStaticValue},getBlackStaticValue:function(){this.determineStaticValues();return this.blackStaticValue},determineStaticValues:function(){if(!(0<this.whiteStaticValue||0<this.blackStaticValue)){this.blackStaticValue=this.whiteStaticValue=0;for(var a,
b=1;9>b;b++)for(var d=1;9>d;d++)if(this.board.hasPiece(b,d)){switch(this.board.getPiece(b,d)){case "Q":case "q":a=9.75;break;case "R":case "r":a=5;break;case "B":case "b":a=3.25;break;case "N":case "n":a=3.25;break;case "P":case "p":a=1;break;default:continue}a*=10;p.isWhite(this.board.getPiece(b,d))?this.whiteStaticValue+=a:this.blackStaticValue+=a}}},getWhiteDynamicValue:function(){this.determineDynamicValues();return this.whiteDynamicValue},getBlackDynamicValue:function(){this.determineDynamicValues();
return this.blackDynamicValue},determineDynamicValues:function(){if(!(0<this.whiteDynamicValue||0<this.blackDynamicValue)){this.blackDynamicValue=this.whiteDynamicValue=0;2<=this.findPiece("b").length&&(this.blackDynamicValue+=5);2<=this.findPiece("B").length&&(this.whiteDynamicValue+=5);var a=this.getBlacksCoveredSquares();this.blackDynamicValue+=Math.round(a.length/2);a=this.getWhitesCoveredSquares();this.whiteDynamicValue+=Math.round(a.length/2)}},getBestMoveForWhite:function(){return this.getBestMove(!0)},
getBestMoveForBlack:function(){return this.getBestMove(!1)},getBestMoveSimple:function(a){for(var b=[],d=1;9>d;d++)for(var c=1;9>c;c++)if(this.board.hasPiece(d,c)&&p.isWhite(this.board.getPiece(d,c))==a){var f=this.getValidMovesForSquare(d,c);if(0!=f.length)for(var e=0;e<f.length;e++){var k=""+g.name(d,c)+f[e].name,l=this.evaluateMove(k);if(1E3==Math.abs(l))return k;b.push({move:k,value:l})}}d=function(a,b){return a.value-b.value};a&&(d=function(a,b){return b.value-a.value});b.sort(d);if(this.mark)for(e=
0;e<b.length;e++)console.log(b[e].move+": "+b[e].value);return b[0].move},evaluateMove:function(a){var b=this.clone();b.move(a);return b.evaluatePosition()},clone:function(){var a=EngineFactory.create();a.setFromBoard(a.board);return a}},c,e;q.getBestMove=function(a){this.lastBestMove="";c=this.lastValue=0;e={};var b=(new Date).getTime();this.alphabeta(this.searchPly,-1E4,1E4,a);b=((new Date).getTime()-b)/1E3;console.log((a?"white":"black")+" to move; examined: "+c+" nodes in "+b+"s ("+Math.round(c/
b)+"n/s); best: "+this.lastBestMove+" ("+this.lastValue+")");return this.lastBestMove};q.alphabeta=function(a,b,d,h){c++;var f=this.getPositionFEN()+" "+(this.board.getColorToMove()==n.white?"w":"b"),g;if(0==a){if(e[f])return e[f];g=this.evaluatePosition();return e[f]=g}var f=this.clone(),k,l;if(h){k=this.getValidMovesForWhite();for(var m=0;m<k.length;m++){f.setFromBoard(this.board);f.move(k[m]);l=b;if(f.blackInCheckmate()){b=1E3;this.lastBestMove=k[m];this.lastValue=b;break}else g=f.alphabeta(a-
1,b,d,!h),b=Math.max(b,g);l!=b&&(this.lastBestMove=k[m],this.lastValue=g);if(d<=b)break}return b}k=this.getValidMovesForBlack();for(m=0;m<k.length;m++){f.setFromBoard(this.board);f.move(k[m]);l=d;if(f.whiteInCheckmate()){d=-1E3;this.lastBestMove=k[m];this.lastValue=d;break}else g=f.alphabeta(a-1,b,d,!h),d=Math.min(d,g);l!=d&&(this.lastBestMove=k[m],this.lastValue=d);if(d<=b)break}return d};q.evaluatePosition=function(){if(this.whiteInCheckmate())return-1E3;if(this.blackInCheckmate())return 1E3;var a;
a=0+this.getWhiteStaticValue();a-=this.getBlackStaticValue();a+=this.getWhiteDynamicValue();return a-=this.getBlackDynamicValue()};EngineFactory=function(){return{create:function(a){"undefined"===typeof a&&(a=BoardFactory.create());return Object.create(q).init(a)}}}()})();
