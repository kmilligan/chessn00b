var BoardFactory;
(function(){"function"!==typeof Object.create&&(Object.create=function(c){function e(){}e.prototype=c;return new e});var q={R:"\u2656",N:"\u2658",B:"\u2657",Q:"\u2655",K:"\u2654",P:"\u2659",r:"\u265c",n:"\u265e",b:"\u265d",q:"\u265b",k:"\u265a",p:"\u265f",isWhite:function(c){if("string"!=typeof c)throw Error('Got a non-string piece "'+c+'"');return 91>c.charCodeAt(0)?!0:!1},getColor:function(c){return this.isWhite(c)?h.white:h.black}},m={1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",a:"1",b:"2",
c:"3",d:"4",e:"5",f:"6",g:"7",h:"8",name:function(c,e){return m[c]+e},coords:function(c){return{file:parseInt(m[c.substr(0,1)],10),rank:parseInt(c.substr(1,1),10)}}},h={white:8,black:0},p={init:function(){this.colorToMove=h.white;this.enpassantTarget=this.castlingOptions="-";this.fullMoveNumber=this.halfMoveClock=0;this.squares=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,
-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];this.squareColors=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];return this},copyFrom:function(c){this.squares=c.squares.slice();
this.colorToMove=c.colorToMove;this.castlingOptions=c.castlingOptions;this.enpassantTarget=c.enpassantTarget;this.haveMoveClock=c.halfMoveClock;this.fullMoveNumber=c.fullMoveNumber},setFEN:function(c){c=c.split(" ");for(var e=c[0].split("/"),g=8;0<g;g--)this.setRankFEN(g,e[8-g]);this.colorToMove="w"==c[1]?h.white:h.black;c[2]&&(this.castlingOptions=c[2]);c[3]&&(this.enpassantTarget=c[3]);"undefined"!=typeof c[4]&&(this.halfMoveClock=parseInt(c[4],10));"undefined"!=typeof c[5]&&(this.fullMoveNumber=
parseInt(c[5],10))},setRankFEN:function(c,e){var g=e.split(""),a=1,b;for(b in g){if(8<a||" "==g[b])break;if(q[g[b]])this.setPiece(g[b],a,c),a++;else for(;0<g[b];)this.removePiece(a,c),g[b]--,a++}},getColorToMove:function(){return this.colorToMove},incrementMove:function(){this.colorToMove==h.white?this.colorToMove=h.black:(this.colorToMove=h.white,this.fullMoveNumber++)},ap:function(c,e){return 10*(10-parseInt(e,10))+parseInt(c,10)},apToName:function(c){return m.name(c%10,10-Math.floor(c/10))},setPiece:function(c,
e,g){this.squares[this.ap(e,g)]=c},removePiece:function(c,e){this.squares[this.ap(c,e)]=0},hasPiece:function(c,e){var g;g="undefined"===typeof e?c:this.ap(c,e);return"string"===typeof this.squares[g]?!0:!1},getPiece:function(c,e){return this.squares[this.ap(c,e)]},getPieceCount:function(){for(var c=0,e=8;0<e;e--)for(var g=1;9>g;g++)this.hasPiece(g,e)&&c++;return c},getSquareColor:function(c,e){"undefined"==typeof e&&"string"==typeof c&&(e=c.substr(1,1),c=m[c.substr(0,1)]);return this.squareColors[this.ap(c,
e)]},getCoveredSquares:function(c,e){var g=[],a=[];switch(this.getPiece(c,e)){case "K":case "k":g=this.getStraightOptions(c,e,1);a=this.getDiagonalOptions(c,e,1);break;case "Q":case "q":g=this.getStraightOptions(c,e,8);a=this.getDiagonalOptions(c,e,8);break;case "R":case "r":g=this.getStraightOptions(c,e,8);break;case "B":case "b":a=this.getDiagonalOptions(c,e,8);break;case "N":case "n":g=this.getKnightOptions(c,e);break;case "P":case "p":g=this.getPawnOptions(c,e)}for(var b=0;b<a.length;b++)g.push(a[b]);
return g},getStraightOptions:function(c,e,g){for(var a=[],b=[-1,-10,1,10],d=this.ap(c,e),k,f=0;f<b.length;f++)for(e=b[f],k=d,c=0;c<g;){k+=e;if(0>this.squares[k])break;a.push(this.apToName(k));if(this.hasPiece(k))break;c++}return a},getDiagonalOptions:function(c,e,g){for(var a=[],b=[-11,-9,9,11],d=this.ap(c,e),k,f=0;f<b.length;f++)for(e=b[f],k=d,c=0;c<g;){k+=e;if(0>this.squares[k])break;a.push(this.apToName(k));if(this.hasPiece(k))break;c++}return a},getKnightOptions:function(c,e){for(var g=[],a=[-21,
-19,-8,12,21,19,8,-12],b,d=this.ap(c,e),k=0;k<a.length;k++)b=a[k],b=d+b,0>this.squares[b]||g.push(this.apToName(b));return g},getPawnOptions:function(c,e){for(var g=[],a=q.isWhite(this.getPiece(c,e))?[-11,-9]:[11,9],b,d=this.ap(c,e),k=0;k<a.length;k++)b=a[k],b=d+b,0>this.squares[b]||g.push(this.apToName(b));return g},dump:function(){console.log("-----------------");for(var c=8;0<c;c--){for(var e="|",g=1;9>g;g++)e=this.hasPiece(g,c)?e+this.getPiece(g,c):e+" ",e+="|";console.log(e);console.log("-----------------")}}};
BoardFactory=function(){return{create:function(){return Object.create(p).init()},getPieceMap:function(){return q},getFileMap:function(){return m},getColorMap:function(){return h}}}()})();
(function(q){q.fn.chessn00b=function(a){a||(a={});if("string"==typeof a&&1==this.length&&this[0].displayboard)switch(a){case "fen":return this[0].displayboard.getFEN();default:return"unsupported option"}return this.each(function(){if(!this.displayboard){var b="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";a.fen&&(b=a.fen);a.element=q(this);this.displayboard=Object.create(g).init(a);this.displayboard.setFEN(b)}})};var m=BoardFactory.getPieceMap(),h=BoardFactory.getColorMap(),p=BoardFactory.getFileMap(),
c={"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR":["e7e5"],"rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R":["b8c6"],"rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR":["g7g6"]},e={init:function(a){this.square=a;this.element=q('<div class="chessn00b-square">&nbsp;</div>');this.element[0].displaySquare=this;this.element.attr("rel",a.name);this.element.addClass(this.square.color==h.white?
"chessn00b-light-square":"chessn00b-dark-square");return this},lite:function(){this.element.addClass("chessn00b-square-lit")},unlite:function(){this.element.removeClass("chessn00b-square-lit")},toggleLite:function(){this.element.hasClass("chessn00b-square-lit")?this.unlite():this.lite()}},g={init:function(a){if(!a||!a.element)throw Error('Missing options; requires at least "element" to attach to.');"undefined"===typeof a.playGame&&(a.playGame=!0);a.displayGameScore=!1;"undefined"===typeof a.gameScoreSelector?
a.displayGameScore=!1:"string"===typeof a.gameScoreSelector&&(this.gameScoreElement=q(a.gameScoreSelector),0<this.gameScoreElement.length&&(a.displayGameScore=!0));"undefined"===typeof a.notationType&&(a.notationType="SAN");"boolean"!==typeof a.coordinates&&(a.coordinates=!1);this.element=a.element;this.board=BoardFactory.create();this.engine=EngineFactory.create(this.board);this.playGame=a.playGame;this.lastClickedSquare=null;this.displaySquares=[];this.thinking=!1;this.options=a;this.gameScore=
"";this.currentPieceCount=this.board.getPieceCount();this.id="board"+Math.floor(1E6*Math.random());this.element.addClass(this.id);for(a=1;9>a;a++)for(var b=1;9>b;b++)1==b&&(this.displaySquares[a]=[]),this.displaySquares[a][b]=Object.create(e).init({file:a,rank:b,color:this.board.getSquareColor(a,b),name:p.name(a,b)});this.createDisplay();return this},createDisplay:function(){this.element.append('<div class="chessn00b-outer-board"><div class="chessn00b-inner-board"></div></div>');for(var a=this.element.find(".chessn00b-inner-board"),
b=this.element.find(".chessn00b-outer-board"),d=8;0<d;d--){for(var k=q('<div class="chessn00b-rank" rel="'+d+'"></div>'),f=1;9>f;f++)k.append(this.displaySquares[f][d].element);a.append(k)}if(this.options.coordinates){a=q('<div class="chessn00b-file-markers"></div>');for(f=1;9>f;f++)a.append('<div class="chessn00b-file-marker">'+p[f]+"</div>");f=q('<div class="chessn00b-rank-markers"></div>');for(d=8;0<d;d--)f.append('<div class="chessn00b-rank-marker">'+d+"</div>");b.append(f);b.append(a)}this.element.append('<div class="chessn00b-status"><span class="illegal-move">Illegal move. </span><span class="your-move">Your move</span><span class="game-over">Game Over. </span><span class="you-win">You win!</span><span class="you-lose">You lose!</span><span class="draw">Draw.</span><span class="thinking">Thinking...</span></div>');
this.element.find(".illegal-move").hide();this.element.find(".thinking").hide();this.element.find(".game-over").hide();this.element.find(".you-lose").hide();this.element.find(".you-win").hide();this.element.find(".draw").hide();this.element.append('<div class="chessn00b-promote"><a href="#" class="chessn00b-square promote-white" rel="Q">'+m.Q+'</a><a href="#" class="chessn00b-square promote-black" rel="q">'+m.q+'</a><a href="#" class="chessn00b-square promote-white" rel="R">'+m.R+'</a><a href="#" class="chessn00b-square promote-black" rel="r">'+
m.r+'</a><a href="#" class="chessn00b-square promote-white" rel="B">'+m.B+'</a><a href="#" class="chessn00b-square promote-black" rel="b">'+m.b+'</a><a href="#" class="chessn00b-square promote-white" rel="N">'+m.N+'</a><a href="#" class="chessn00b-square promote-black" rel="n">'+m.n+"</a></div>");this.element.append('<div class="chessn00b-animator chessn00b-square"></div>');this.playGame||this.element.find(".your-move").hide();this.autosetHeight();var c=this;this.element.on("click",".chessn00b-rank .chessn00b-square",
function(){c.squareClicked(q(this));return!1})},autosetHeight:function(){var a=Math.ceil(this.element.width()/9);"undefined"==typeof this.dynCSS&&(this.dynCSS=document.createElement("style"),document.getElementsByTagName("head")[0].appendChild(this.dynCSS));var b="."+this.id+" .chessn00b-inner-board, .chessn00b-file-markers { width: "+8*a+"px; }",b=b+("."+this.id+" .chessn00b-square { font-size: "+Math.ceil(.82*a)+"px;  height: "+a+"px;  line-height: "+a+"px; }"),b=b+("."+this.id+" .chessn00b-rank-marker { height: "+
a+"px;  line-height: "+a+"px; }"),b=b+("."+this.id+" .chessn00b-promote {  top: -"+Math.ceil(5*a)+"px; left: "+Math.ceil(2.2*a)+"px; }"),b=b+("."+this.id+" .chessn00b-animator {  width: "+a+"px; }");this.dynCSS.styleSheet?this.dynCSS.styleSheet.cssText=b:this.dynCSS.innerHTML=b},squareClicked:function(a){if(!this.thinking)if(this.element.find(".illegal-move").hide(),this.lastClickedSquare)if(a[0]==this.lastClickedSquare)this.lastClickedSquare.displaySquare.unlite(),this.lastClickedSquare=null;else{this.lastClickedSquare.displaySquare.unlite();
var b=""+this.lastClickedSquare.displaySquare.square.name+a[0].displaySquare.square.name,d=this,k=function(){d.engine.isValidMove(b)?(d.engine.move(b),d.update(b),d.lastClickedSquare=null,d.playGame&&d.autoMove()):(d.element.find(".illegal-move").show(),d.lastClickedSquare=null)};this.engine.isPromotionPossible(b)?(this.element.find(".chessn00b-promote").css("display","inline-block"),this.element.find(".chessn00b-promote .promote-white").show(),this.element.find(".chessn00b-promote .promote-black").hide(),
this.element.on("click.promote","a",function(){d.element.off("click.promote");d.element.find(".chessn00b-promote").hide();b+=q(this).attr("rel");k();return!1})):k()}else a[0].displaySquare.lite(),this.lastClickedSquare=a[0]},autoMove:function(){this.thinking=!0;this.element.find(".your-move").hide();this.element.find(".thinking").show();var a=this;setTimeout(function(){var b,d=a.engine.blackInCheckmate(),k=a.engine.inStalemate(!1);if(d||k)a.thinking=!1,a.element.find(".thinking").hide(),a.element.find(".game-over").show(),
d?a.element.find(".you-win").show():a.element.find(".draw").show();else{var f=function(b){a.engine.move(b);a.animate(b);a.thinking=!1;a.element.find(".thinking").hide();d=a.engine.whiteInCheckmate();k=a.engine.inStalemate(!0);d||k?(a.element.find(".game-over").show(),d?a.element.find(".you-lose").show():a.element.find(".draw").show()):a.element.find(".your-move").show()};(b=c[a.getFEN()])?(b=b[Math.round(Math.random()*(b.length-1))],f(b)):b=a.engine.getBestMove(!1,f)}},20)},setFEN:function(a){this.board.setFEN(a);
this.update()},getFEN:function(){return this.engine.getPositionFEN()},update:function(a){this.updateDisplayBoard();"undefined"!==typeof a&&this.updateGameScore(a)},updateDisplayBoard:function(){for(var a=1;9>a;a++)for(var b=1;9>b;b++)this.board.hasPiece(a,b)?this.displaySquares[a][b].element.html(m[this.board.getPiece(a,b)]):this.displaySquares[a][b].element.html("&nbsp;")},updateGameScore:function(a){var b=this.board.getPieceCount(),d=!1;b<this.currentPieceCount&&(d=!0);this.currentPieceCount=b;
b="";this.board.colorToMove!=h.white&&(b+=""+this.board.fullMoveNumber+". ");b+=this.convertNotation(a,d);this.board.colorToMove==h.white&&this.engine.whiteInCheck()?b+="+":this.board.colorToMove==h.black&&this.engine.blackInCheck()&&(b+="+");this.gameScore+=b+" ";this.options.displayGameScore&&this.gameScoreElement.html(this.gameScore)},convertNotation:function(a,b){var d=p.coords(a.substr(0,2)),k=p.coords(a.substr(2,2)),f=a.substr(2,3),c=this.board.getPiece(k.file,k.rank);"p"==c||"P"==c?d=b?a.substr(0,
1)+"x"+f:f:"k"!=c&&"K"!=c||2!=Math.abs(d.file-k.file)?(d="FAN"==this.options.notationType?m[c]:c.toUpperCase(),b&&(d+="x"),d+=f):d=d.file<k.file?"O-O":"O-O-O";return d},animate:function(a){var b=p.coords(a.substr(0,2)),d=p.coords(a.substr(2,2)),k=this.displaySquares[d.file][d.rank].element.offset(),c=this.element.find(".chessn00b-animator"),e=this.displaySquares[b.file][b.rank].element.offset();c.html(m[this.board.getPiece(d.file,d.rank)]);this.displaySquares[b.file][b.rank].element.html("&nbsp;");
var n=this;c.css("top",e.top+"px").css("left",e.left+"px").css("display","block").animate({left:k.left,top:k.top},400,function(){c.css("display","none");n.update(a)})}}})(jQuery);if("undefined"===typeof BoardFactory)throw console&&console.log("Missing the BoardFactory!"),Error("Missing the BoardFactory!");var EngineFactory;
(function(){var q=BoardFactory.getPieceMap(),m=BoardFactory.getColorMap(),h=BoardFactory.getFileMap(),p={init:function(a){this.board=a;this.searchPly=3;this.resetCaches();return this},resetCaches:function(){this.whiteCoveredSquares=[];this.blackCoveredSquares=[];this.blackDynamicValue=this.whiteDynamicValue=this.blackStaticValue=this.whiteStaticValue=0;this.cachedPositionFEN=null;this.validWhiteMoves=[];this.validBlackMoves=[]},getWhitesCoveredSquares:function(){this.determineCoveredSquares(!0);return this.whiteCoveredSquares},
getBlacksCoveredSquares:function(){this.determineCoveredSquares(!1);return this.blackCoveredSquares},getValidMovesForWhite:function(){this.determineValidMoves(!0);return this.validWhiteMoves},getValidMovesForBlack:function(){this.determineValidMoves(!1);return this.validBlackMoves},getValidMovesFor:function(a){this.determineValidMoves(a);return a?this.validWhiteMoves:this.validBlackMoves},determineValidMoves:function(a){if(!(a&&0<this.validWhiteMoves.length||!a&&0<this.validBlackMoves.length)){a&&
(this.validWhiteMoves=[]);a||(this.validBlackMoves=[]);for(var b,d,k,c,e=1;9>e;e++)for(var n=1;9>n;n++)if(this.board.hasPiece(e,n)&&(b=h.name(e,n),k=q.isWhite(this.board.getPiece(e,n)),k==a)){c=this.getValidMovesForSquare(e,n);for(var l=0;l<c.length;l++)d=""+b+c[l],k?this.validWhiteMoves.push(d):this.validBlackMoves.push(d)}}},getValidMovesForSquare:function(a,b){var d=[];if(!this.board.hasPiece(a,b))return d;var c=this.board.getPiece(a,b),f=q.isWhite(c),e="k"==c||"K"==c?!0:!1,n="p"==c||"P"==c?!0:
!1,c=h.name(a,b);this.getPositionFEN();var l=EngineFactory.create(),g=this.board.getCoveredSquares(a,b);if(0==g.length)return d;for(var m,p,t,r=0;r<g.length;r++)m=h[g[r].substr(0,1)],p=g[r].substr(1,1),t=this.board.hasPiece(m,p),m=this.board.getPiece(m,p),t&&q.isWhite(m)==f||n&&!t||(l.setFromBoard(this.board),t=""+c+g[r],l.move(t,!0),f&&l.whiteInCheck()||!f&&l.blackInCheck()||(n?f&&8==p?(d.push(g[r]+"Q"),d.push(g[r]+"R"),d.push(g[r]+"B"),d.push(g[r]+"N")):f||1!=p?d.push(g[r]):(d.push(g[r]+"q"),d.push(g[r]+
"r"),d.push(g[r]+"b"),d.push(g[r]+"n")):d.push(g[r])));n&&(f?8>b&&!this.board.hasPiece(a,b+1)&&(l.setFromBoard(this.board),t=""+c+h.name(a,b+1),l.move(t,!0),l.whiteInCheck()||(7>b?d.push(h.name(a,b+1)):(n=h.name(a,b+1),d.push(n+"Q"),d.push(n+"R"),d.push(n+"N"),d.push(n+"B"))),2!=b||this.board.hasPiece(a,b+2)||(l.setFromBoard(this.board),t=""+c+h.name(a,b+2),l.move(t,!0),l.whiteInCheck()||d.push(h.name(a,b+2)))):1<b&&!this.board.hasPiece(a,b-1)&&(l.setFromBoard(this.board),t=""+c+h.name(a,b-1),l.move(t,
!0),l.blackInCheck()||(2<b?d.push(h.name(a,b-1)):(n=h.name(a,b-1),d.push(n+"q"),d.push(n+"r"),d.push(n+"n"),d.push(n+"b"))),7!=b||this.board.hasPiece(a,b-2)||(l.setFromBoard(this.board),t=""+c+h.name(a,b-2),l.move(t,!0),l.blackInCheck()||d.push(h.name(a,b-2)))));e&&(f&&!this.whiteInCheck()&&1==b?(!(0<=this.board.castlingOptions.indexOf("K"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByBlack(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByBlack(a+2,b)||d.push(h.name(a+2,b)),!(0<=
this.board.castlingOptions.indexOf("Q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByBlack(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByBlack(a-2,b)||d.push(h.name(a-2,b))):f||this.blackInCheck()||8!=b||(!(0<=this.board.castlingOptions.indexOf("k"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByWhite(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByWhite(a+2,b)||d.push(h.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByWhite(a-
1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByWhite(a-2,b)||d.push(h.name(a-2,b))));return d},isPromotionPossible:function(a){a=h.coords(a.substr(0,2));if(this.board.hasPiece(a.file,a.rank)){var b=this.board.getPiece(a.file,a.rank);if("p"==b&&2==a.rank||"P"==b&&7==a.rank)return!0}return!1},isValidMove:function(a,b){var d,c;d="object"==typeof a?a:h.coords(a.substr(0,2));c="object"==typeof b?h.name(b.file,b.rank):a.substr(2,3);if(!this.board.hasPiece(d.file,d.rank)||q.getColor(this.board.getPiece(d.file,
d.rank))!=this.board.getColorToMove())return!1;d=this.getValidMovesForSquare(d.file,d.rank);for(var f=0;f<d.length;f++)if(d[f]===c)return!0;return!1},determineCoveredSquares:function(a){if(!(a&&0<this.whiteCoveredSquares.length||!a&&0<this.blackCoveredSquares.legnth)){a&&(this.whiteCoveredSquares=[]);a||(this.blackCoveredSquares=[]);for(var b,d=1;9>d;d++)for(var c=1;9>c;c++)if(this.board.hasPiece(d,c)){var f=q.isWhite(this.board.getPiece(d,c));if(f==a){b=this.board.getCoveredSquares(d,c);var e=this.blackCoveredSquares;
f&&(e=this.whiteCoveredSquares);for(f=0;f<b.length;f++)e.push(b[f])}}}},findPiece:function(a){for(var b=[],d=1;9>d;d++)for(var c=1;9>c;c++)this.board.hasPiece(d,c)&&this.board.getPiece(d,c)==a&&b.push({file:d,rank:c});return b},isSquareAttacked:function(a,b){if(!this.board.hasPiece(a,b))return!1;var d=h.name(a,b),c;c=q.isWhite(this.board.getPiece(a,b))?this.getBlacksCoveredSquares():this.getWhitesCoveredSquares();for(var f=0;f<c.length;f++)if(c[f]==d)return!0;return!1},isSquareAttackedByWhite:function(a,
b){for(var d=h.name(a,b),c=this.getWhitesCoveredSquares(),f=0;f<c.length;f++)if(c[f]==d)return!0;return!1},isSquareAttackedByBlack:function(a,b){for(var d=h.name(a,b),c=this.getBlacksCoveredSquares(),f=0;f<c.length;f++)if(c[f]==d)return!0;return!1},getPositionFEN:function(){if(this.cachedPositionFEN)return this.cachedPositionFEN;for(var a=[],b=8;0<b;b--){for(var d="",c=0,f=1;9>f;f++)this.board.hasPiece(f,b)?(0<c&&(d+=c,c=0),d+=this.board.getPiece(f,b)):c++;0<c&&(d+=c);a.push(d)}return this.cachedPositionFEN=
a.join("/")},setFEN:function(a){this.resetCaches();this.board.setFEN(a)},setFromBoard:function(a){this.resetCaches();this.board.copyFrom(a)},inStalemate:function(a){return this.inCheck(a)?!1:0==this.getValidMovesFor(a).length?!0:!1},inCheck:function(a){a=this.findPiece(a?"K":"k");if(0==a.length)throw Error("Invalid position; missing king");return this.isSquareAttacked(a[0].file,a[0].rank)},blackInCheck:function(){return this.inCheck(!1)},whiteInCheck:function(){return this.inCheck(!0)},inCheckmate:function(a){return this.inCheck(a)?
0==this.getValidMovesFor(a).length?!0:!1:!1},blackInCheckmate:function(){return this.inCheckmate(!1)},whiteInCheckmate:function(){return this.inCheckmate(!0)},moves:function(a){"string"==typeof a&&(a=a.split(" "));for(var b=0;b<a.length;b++)if(!this.move(a[b]))return!1;return!0},move:function(a,b){var d,c;if(!a)throw Error("Missing move! Remember that getBestMove is non-blocking!");b=!0===b?!0:!1;var f=h.coords(a.substr(0,2)),e=h.coords(a.substr(2,2)),g=null;4<a.length&&(g=a.substr(4,1));if(!this.board.hasPiece(f.file,
f.rank)||!b&&!this.isValidMove(a))return!1;var l=this.board.getPiece(f.file,f.rank);this.board.removePiece(f.file,f.rank);this.board.setPiece(l,e.file,e.rank);if((d="k"==l||"K"==l?!0:!1)&&2==Math.abs(f.file-e.file)){var m;e.file>f.file?(m={file:e.file+1,rank:e.rank},d=e.file-1):(m={file:e.file-2,rank:e.rank},d=e.file+1);c=e.rank;var p=this.board.getPiece(m.file,m.rank);p||(console.log(f),console.log(e),console.log(m),this.board.dump());this.board.removePiece(m.file,m.rank);this.board.setPiece(p,d,
c);q.isWhite(p)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=this.board.castlingOptions.replace(/[kq]/g,"");""==this.board.castlingOptions&&(this.board.castlingOptions="-")}else d&&(q.isWhite(l)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=this.board.castlingOptions.replace(/[kq]/g,""));"r"==l?1==f.file?this.board.castlingOptions=this.board.castlingOptions.replace("q",""):8==f.file&&(this.board.castlingOptions=
this.board.castlingOptions.replace("k","")):"R"==l&&(1==f.file?this.board.castlingOptions=this.board.castlingOptions.replace("Q",""):8==f.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("K","")));g&&this.board.setPiece(g,e.file,e.rank);this.board.incrementMove();this.resetCaches();return!0},getWhiteStaticValue:function(){this.determineStaticValues();return this.whiteStaticValue},getBlackStaticValue:function(){this.determineStaticValues();return this.blackStaticValue},determineStaticValues:function(){if(!(0<
this.whiteStaticValue||0<this.blackStaticValue)){this.blackStaticValue=this.whiteStaticValue=0;for(var a,b=1;9>b;b++)for(var d=1;9>d;d++)if(this.board.hasPiece(b,d)){switch(this.board.getPiece(b,d)){case "Q":case "q":a=9.75;break;case "R":case "r":a=5;break;case "B":case "b":a=3.25;break;case "N":case "n":a=3.25;break;case "P":case "p":a=1;break;default:continue}a*=10;q.isWhite(this.board.getPiece(b,d))?this.whiteStaticValue+=a:this.blackStaticValue+=a}}},getWhiteDynamicValue:function(){this.determineDynamicValues();
return this.whiteDynamicValue},getBlackDynamicValue:function(){this.determineDynamicValues();return this.blackDynamicValue},determineDynamicValues:function(){if(!(0<this.whiteDynamicValue||0<this.blackDynamicValue)){this.blackDynamicValue=this.whiteDynamicValue=0;2<=this.findPiece("b").length&&(this.blackDynamicValue+=5);2<=this.findPiece("B").length&&(this.whiteDynamicValue+=5);var a=this.getBlacksCoveredSquares();this.blackDynamicValue+=Math.round(a.length/2);a=this.getWhitesCoveredSquares();this.whiteDynamicValue+=
Math.round(a.length/2);var b=a=0;"N"==this.board.getPiece(2,1)&&a++;"B"==this.board.getPiece(3,1)&&a++;"B"==this.board.getPiece(6,1)&&a++;"N"==this.board.getPiece(7,1)&&a++;"n"==this.board.getPiece(2,8)&&b++;"b"==this.board.getPiece(3,8)&&b++;"b"==this.board.getPiece(6,8)&&b++;"n"==this.board.getPiece(7,8)&&b++;a>b&&(this.blackDynamicValue+=5);b>a&&(this.whiteDynamicValue+=5)}},getBestMoveForWhite:function(){return this.getBestMove(!0)},getBestMoveForBlack:function(){return this.getBestMove(!1)},
evaluateMove:function(a){var b=this.clone();b.move(a);return b.evaluatePosition()},clone:function(){var a=EngineFactory.create();a.setFromBoard(this.board);return a}},c,e,g;p.getBestMove=function(a,b){this.lastBestMove="";c=this.lastValue=0;var d=(new Date).getTime(),k=this;e=!1;g=(new Date).getTime();this.organizeAndSearch(a,function(){var f=((new Date).getTime()-d)/1E3;console.log((a?"white":"black")+" to move; examined: "+c+" nodes in "+f+"s ("+Math.round(c/f)+"n/s); best: "+k.lastBestMove+" ("+
k.lastValue+")");"function"===typeof b&&b(k.lastBestMove)})};p.organizeAndSearch=function(a,b){var d=this.getValidMovesFor(a),k=d.length;if(0==k)this.lastValue=this.evaluatePosition();else{this.moveOptions=[];var f=this,h;h=a?function(a,b){return b.value-a.value}:function(a,b){return a.value-b.value};for(var n=this.clone(),l=0;l<k;l++){c++;n.setFromBoard(this.board);n.move(d[l]);var m={move:d[l]};m.engine=this.clone();m.engine.move(d[l]);m.value=m.engine.evaluatePosition();this.moveOptions.push(m)}this.moveOptions.sort(h);
if(1E3==Math.abs(this.moveOptions[0].value))this.lastBestMove=this.moveOptions[0].move,this.lastValue=this.moveOptions[0].value;else for(var d=1,k=Math.floor(this.moveOptions.length/4),p,q,n=function(b,d){for(var c=0;c<d;c++)if(f.moveOptions[c].engine.alphabeta(b,-1E4,1E4,!a),p=(new Date).getTime(),q=p-g,1E3<q){e=!0;break}};;){n(d,k);this.moveOptions.sort(h);this.lastBestMove=this.moveOptions[0].move;this.lastValue=this.moveOptions[0].value;if(e)break;d++;k=Math.floor(k/2);if(0==k)break}}b()};p.alphabeta=
function(a,b,d,g){c++;var f=this.getValidMovesFor(g),h=f.length;if(0==h)return this.evaluatePosition();for(var n,l=this.clone(),m=0;m<h;m++){if(e){console.log("time break");break}l.setFromBoard(this.board);l.move(f[m]);if(l.inCheckmate(!g)){this.lastBestMove=f[m];this.lastValue=l.evaluatePosition();g?b=this.lastValue:d=this.lastValue;break}0==a?(c++,n=l.evaluatePosition()):n=l.alphabeta(a-1,b,d,!g);g?b<n&&(b=n,this.lastBestMove=f[m],this.lastValue=n):d>n&&(d=n,this.lastBestMove=f[m],this.lastValue=
n);if(d<=b)break}return g?b:d};p.alphabetaOld=function(a,b,d,e){c++;var f;if(0==a)return this.evaluatePosition();var g=this.clone(),h;if(e){h=this.getValidMovesForWhite();for(var l=0;l<h.length;l++){g.setFromBoard(this.board);g.move(h[l]);if(g.blackInCheckmate()){b=1E3;this.lastBestMove=h[l];this.lastValue=b;break}f=g.alphabetaOld(a-1,b,d,!e);b<f&&(b=f,this.lastBestMove=h[l],this.lastValue=f);if(d<=b)break}return b}h=this.getValidMovesForBlack();for(l=0;l<h.length;l++){g.setFromBoard(this.board);
g.move(h[l]);5==a&&g.board.dump();if(g.whiteInCheckmate()){d=-1E3;this.lastBestMove=h[l];this.lastValue=d;break}f=g.alphabeta(a-1,b,d,!e);d>f&&(d=f,this.lastBestMove=h[l],this.lastValue=d);if(d<=b)break}return d};p.evaluatePosition=function(){if(this.whiteInCheckmate())return-1E3;if(this.blackInCheckmate())return 1E3;var a=0,b=this.board.getColorToMove()==m.white?!0:!1;if(this.inStalemate(b))return a;a+=this.getWhiteStaticValue();a-=this.getBlackStaticValue();a+=this.getWhiteDynamicValue();return a-=
this.getBlackDynamicValue()};EngineFactory=function(){return{create:function(a){"undefined"===typeof a&&(a=BoardFactory.create());return Object.create(p).init(a)}}}()})();
