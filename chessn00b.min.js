var BoardFactory;
(function(){"function"!==typeof Object.create&&(Object.create=function(c){function f(){}f.prototype=c;return new f});var p={R:"\u2656",N:"\u2658",B:"\u2657",Q:"\u2655",K:"\u2654",P:"\u2659",r:"\u265c",n:"\u265e",b:"\u265d",q:"\u265b",k:"\u265a",p:"\u265f",isWhite:function(c){return 91>c.charCodeAt(0)?!0:!1},getColor:function(c){return this.isWhite(c)?h.white:h.black}},m={1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",a:"1",b:"2",c:"3",d:"4",e:"5",f:"6",g:"7",h:"8",name:function(c,f){return m[c]+
f},coords:function(c){return{file:parseInt(m[c.substr(0,1)],10),rank:parseInt(c.substr(1,1),10)}}},h={white:8,black:0},r={init:function(){this.colorToMove=h.white;this.enpassantTarget=this.castlingOptions="-";this.fullMoveNumber=this.halfMoveClock=0;this.squares=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,
-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];this.squareColors=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];return this},copyFrom:function(c){this.squares=c.squares.slice();this.colorToMove=c.colorToMove;this.castlingOptions=c.castlingOptions;
this.enpassantTarget=c.enpassantTarget;this.haveMoveClock=c.halfMoveClock;this.fullMoveNumber=c.fullMoveNumber},setFEN:function(c){c=c.split(" ");for(var f=c[0].split("/"),a=8;0<a;a--)this.setRankFEN(a,f[8-a]);this.colorToMove="w"==c[1]?h.white:h.black;c[2]&&(this.castlingOptions=c[2]);c[3]&&(this.enpassantTarget=c[3]);"undefined"!=typeof c[4]&&(this.halfMoveClock=parseInt(c[4],10));"undefined"!=typeof c[5]&&(this.fullMoveNumber=parseInt(c[5],10))},setRankFEN:function(c,f){var a=f.split(""),b=1,d;
for(d in a){if(8<b||" "==a[d])break;if(p[a[d]])this.setPiece(a[d],b,c),b++;else for(;0<a[d];)this.removePiece(b,c),a[d]--,b++}},getColorToMove:function(){return this.colorToMove},incrementMove:function(){this.colorToMove==h.white?this.colorToMove=h.black:(this.colorToMove=h.white,this.fullMoveNumber++)},ap:function(c,f){return 10*(10-parseInt(f,10))+parseInt(c,10)},apToName:function(c){return m.name(c%10,10-Math.floor(c/10))},setPiece:function(c,f,a){this.squares[this.ap(f,a)]=c},removePiece:function(c,
f){this.squares[this.ap(c,f)]=0},hasPiece:function(c,f){var a;a="undefined"===typeof f?c:this.ap(c,f);return"string"===typeof this.squares[a]?!0:!1},getPiece:function(c,f){return this.squares[this.ap(c,f)]},getSquareColor:function(c,f){"undefined"==typeof f&&"string"==typeof c&&(f=c.substr(1,1),c=m[c.substr(0,1)]);return this.squareColors[this.ap(c,f)]},getCoveredSquares:function(c,f){var a=[],b=[];switch(this.getPiece(c,f)){case "K":case "k":a=this.getStraightOptions(c,f,1);b=this.getDiagonalOptions(c,
f,1);break;case "Q":case "q":a=this.getStraightOptions(c,f,8);b=this.getDiagonalOptions(c,f,8);break;case "R":case "r":a=this.getStraightOptions(c,f,8);break;case "B":case "b":b=this.getDiagonalOptions(c,f,8);break;case "N":case "n":a=this.getKnightOptions(c,f);break;case "P":case "p":a=this.getPawnOptions(c,f)}for(var d=0;d<b.length;d++)a.push(b[d]);return a},getStraightOptions:function(c,f,a){for(var b=[],d=[-1,-10,1,10],t=this.ap(c,f),e,l=0;l<d.length;l++)for(f=d[l],e=t,c=0;c<a;){e+=f;if(0>this.squares[e])break;
b.push(this.apToName(e));if(this.hasPiece(e))break;c++}return b},getDiagonalOptions:function(c,f,a){for(var b=[],d=[-11,-9,9,11],t=this.ap(c,f),e,l=0;l<d.length;l++)for(f=d[l],e=t,c=0;c<a;){e+=f;if(0>this.squares[e])break;b.push(this.apToName(e));if(this.hasPiece(e))break;c++}return b},getKnightOptions:function(c,f){for(var a=[],b=[-21,-19,-8,12,21,19,8,-12],d,t=this.ap(c,f),e=0;e<b.length;e++)d=b[e],d=t+d,0>this.squares[d]||a.push(this.apToName(d));return a},getPawnOptions:function(c,f){for(var a=
[],b=p.isWhite(this.getPiece(c,f))?[-11,-9]:[11,9],d,t=this.ap(c,f),e=0;e<b.length;e++)d=b[e],d=t+d,0>this.squares[d]||a.push(this.apToName(d));return a},dump:function(){console.log("-----------------");for(var c=8;0<c;c--){for(var f="|",a=1;9>a;a++)f=this.hasPiece(a,c)?f+this.getPiece(a,c):f+" ",f+="|";console.log(f);console.log("-----------------")}}};BoardFactory=function(){return{create:function(){return Object.create(r).init()},getPieceMap:function(){return p},getFileMap:function(){return m},
getColorMap:function(){return h}}}()})();
(function(p){p.fn.chessn00b=function(b){b||(b={});if("string"==typeof b&&1==this.length&&this[0].displayboard)switch(b){case "fen":return this[0].displayboard.getFEN();default:return"unsupported option"}return this.each(function(){if(!this.displayboard){var d="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";b.fen&&(d=b.fen);b.element=p(this);this.displayboard=Object.create(a).init(b);this.displayboard.setFEN(d)}})};var m=BoardFactory.getPieceMap(),h=BoardFactory.getColorMap(),r=BoardFactory.getFileMap(),
c={"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR":["e7e5"],"rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R":["b8c6"],"rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR":["g7g6"]},f={init:function(b){this.square=b;this.element=p('<div class="chessn00b-square">&nbsp;</div>');this.element[0].displaySquare=this;this.element.attr("rel",b.name);this.element.addClass(this.square.color==h.white?
"chessn00b-light-square":"chessn00b-dark-square");return this},lite:function(){this.element.addClass("chessn00b-square-lit")},unlite:function(){this.element.removeClass("chessn00b-square-lit")},toggleLite:function(){this.element.hasClass("chessn00b-square-lit")?this.unlite():this.lite()}},a={init:function(b){if(!b||!b.element)throw Error('Missing options; requires at least "element" to attach to.');"undefined"===typeof b.playGame&&(b.playGame=!0);this.element=b.element;this.board=BoardFactory.create();
this.engine=EngineFactory.create(this.board);this.playGame=b.playGame;this.lastClickedSquare=null;this.displaySquares=[];this.thinking=!1;this.id="board"+Math.floor(1E6*Math.random());this.element.addClass(this.id);for(b=1;9>b;b++)for(var a=1;9>a;a++)1==a&&(this.displaySquares[b]=[]),this.displaySquares[b][a]=Object.create(f).init({file:b,rank:a,color:this.board.getSquareColor(b,a),name:r.name(b,a)});this.createDisplay();return this},createDisplay:function(){for(var b=8;0<b;b--){for(var a=p('<div class="chessn00b-rank" rel="'+
b+'"></div>'),c=1;9>c;c++)a.append(this.displaySquares[c][b].element);this.element.append(a)}this.element.append('<div class="chessn00b-promote"><a href="#" class="chessn00b-square promote-white" rel="Q">'+m.Q+'</a><a href="#" class="chessn00b-square promote-black" rel="q">'+m.q+'</a><a href="#" class="chessn00b-square promote-white" rel="R">'+m.R+'</a><a href="#" class="chessn00b-square promote-black" rel="r">'+m.r+'</a><a href="#" class="chessn00b-square promote-white" rel="B">'+m.B+'</a><a href="#" class="chessn00b-square promote-black" rel="b">'+
m.b+'</a><a href="#" class="chessn00b-square promote-white" rel="N">'+m.N+'</a><a href="#" class="chessn00b-square promote-black" rel="n">'+m.n+"</a></div>");this.element.append('<div class="chessn00b-status"><span class="illegal-move">Illegal move. </span><span class="your-move">Your move</span><span class="game-over">Game Over. </span><span class="you-win">You win!</span><span class="you-lose">You win!</span><span class="thinking">Thinking...</span></div>');this.element.find(".illegal-move").hide();
this.element.find(".thinking").hide();this.element.find(".game-over").hide();this.element.find(".you-lose").hide();this.element.find(".you-win").hide();this.playGame||this.element.find(".your-move").hide();this.autosetHeight();var e=this;this.element.on("click",".chessn00b-rank .chessn00b-square",function(){e.squareClicked(p(this));return!1})},autosetHeight:function(){var b=this.displaySquares[1][1].element.width();"undefined"==typeof this.dynCSS&&(this.dynCSS=document.createElement("style"),document.getElementsByTagName("head")[0].appendChild(this.dynCSS));
var a="."+this.id+" .chessn00b-square { font-size: "+Math.ceil(.82*b)+"px;  height: "+b+"px;  line-height: "+b+"px; }",a=a+("."+this.id+" .chessn00b-promote {  top: -"+Math.ceil(4*b)+"px; left: "+Math.ceil(2*b)+"px; }");this.dynCSS.styleSheet?this.dynCSS.styleSheet.cssText=a:this.dynCSS.innerHTML=a},squareClicked:function(a){if(!this.thinking)if(this.element.find(".illegal-move").hide(),this.lastClickedSquare)if(a[0]==this.lastClickedSquare)this.lastClickedSquare.displaySquare.unlite(),this.lastClickedSquare=
null;else{this.lastClickedSquare.displaySquare.unlite();var d=""+this.lastClickedSquare.displaySquare.square.name+a[0].displaySquare.square.name,c=this,e=function(){c.engine.isValidMove(d)?(c.engine.move(d),c.update(),c.lastClickedSquare=null,c.playGame&&c.autoMove()):(c.element.find(".illegal-move").show(),c.lastClickedSquare=null)};this.engine.isPromotionPossible(d)?(this.element.find(".chessn00b-promote").show(),this.element.find(".chessn00b-promote .promote-white").show(),this.element.find(".chessn00b-promote .promote-black").hide(),
this.element.on("click.promote","a",function(){c.element.off("click.promote");c.element.find(".chessn00b-promote").hide();d+=p(this).attr("rel");e();return!1})):e()}else a[0].displaySquare.lite(),this.lastClickedSquare=a[0]},autoMove:function(){this.thinking=!0;this.element.find(".your-move").hide();this.element.find(".thinking").show();var a=this;setTimeout(function(){var d;a.engine.blackInCheckmate()?(a.thinking=!1,a.element.find(".thinking").hide(),a.element.find(".game-over").show(),a.element.find(".you-win").show()):
((d=c[a.getFEN()])?(d=d[Math.round(Math.random()*(d.length-1))],console.log("book move used")):d=a.engine.getBestMoveForBlack(),a.engine.move(d),a.thinking=!1,a.element.find(".thinking").hide(),a.update(),a.engine.whiteInCheckmate()?(a.element.find(".game-over").show(),a.element.find(".you-lose").show()):a.element.find(".your-move").show())},0)},setFEN:function(a){this.board.setFEN(a);this.update()},getFEN:function(){return this.engine.getPositionFEN()},update:function(){for(var a=1;9>a;a++)for(var d=
1;9>d;d++)this.board.hasPiece(a,d)||this.displaySquares[a][d].element.html("&nbsp;"),this.displaySquares[a][d].element.html(m[this.board.getPiece(a,d)])}}})(jQuery);if("undefined"===typeof BoardFactory)throw console&&console.log("Missing the BoardFactory!"),Error("Missing the BoardFactory!");var EngineFactory;
(function(){var p=BoardFactory.getPieceMap(),m=BoardFactory.getColorMap(),h=BoardFactory.getFileMap(),r={init:function(a){this.board=a;this.resetCaches();return this},resetCaches:function(){this.whiteCoveredSquares=[];this.blackCoveredSquares=[];this.blackDynamicValue=this.whiteDynamicValue=this.blackStaticValue=this.whiteStaticValue=0;this.cachedPositionFEN=null;this.validWhiteMoves=[];this.validBlackMoves=[]},getWhitesCoveredSquares:function(){this.determineCoveredSquares(!0);return this.whiteCoveredSquares},
getBlacksCoveredSquares:function(){this.determineCoveredSquares(!1);return this.blackCoveredSquares},getValidMovesForWhite:function(){this.determineValidMoves(!0);return this.validWhiteMoves},getValidMovesForBlack:function(){this.determineValidMoves(!1);return this.validBlackMoves},determineValidMoves:function(a){if(!(a&&0<this.validWhiteMoves.length||!a&&0<this.validBlackMoves.length)){a&&(this.validWhiteMoves=[]);a||(this.validBlackMoves=[]);for(var b,d,c,e,f=1;9>f;f++)for(var g=1;9>g;g++)if(this.board.hasPiece(f,
g)&&(b=h.name(f,g),c=p.isWhite(this.board.getPiece(f,g)),c==a)){e=this.getValidMovesForSquare(f,g);for(var k=0;k<e.length;k++)d=""+b+e[k],c?this.validWhiteMoves.push(d):this.validBlackMoves.push(d)}}},getValidMovesForSquare:function(a,b){var d=[];if(!this.board.hasPiece(a,b))return d;var c=this.board.getPiece(a,b),e=p.isWhite(c),f="k"==c||"K"==c?!0:!1,g="p"==c||"P"==c?!0:!1,c=h.name(a,b);this.getPositionFEN();var k=EngineFactory.create(),n=this.board.getCoveredSquares(a,b);if(0==n.length)return d;
for(var m,r,q,u=0;u<n.length;u++)m=h[n[u].substr(0,1)],r=n[u].substr(1,1),q=this.board.hasPiece(m,r),m=this.board.getPiece(m,r),q&&p.isWhite(m)==e||g&&!q||(k.setFromBoard(this.board),q=""+c+n[u],k.move(q,!0),e&&k.whiteInCheck()||!e&&k.blackInCheck()||d.push(n[u]));g&&(e?8>b&&!this.board.hasPiece(a,b+1)&&(k.setFromBoard(this.board),q=""+c+h.name(a,b+1),k.move(q,!0),k.whiteInCheck()||(7>b?d.push(h.name(a,b+1)):(g=h.name(a,b+1),d.push(g+"Q"),d.push(g+"R"),d.push(g+"N"),d.push(g+"B"))),2!=b||this.board.hasPiece(a,
b+2)||(k.setFromBoard(this.board),q=""+c+h.name(a,b+2),k.move(q,!0),k.whiteInCheck()||d.push(h.name(a,b+2)))):1<b&&!this.board.hasPiece(a,b-1)&&(k.setFromBoard(this.board),q=""+c+h.name(a,b-1),k.move(q,!0),k.blackInCheck()||(2<b?d.push(h.name(a,b-1)):(g=h.name(a,b-1),d.push(g+"q"),d.push(g+"r"),d.push(g+"n"),d.push(g+"b"))),7!=b||this.board.hasPiece(a,b-2)||(k.setFromBoard(this.board),q=""+c+h.name(a,b-2),k.move(q,!0),k.blackInCheck()||d.push(h.name(a,b-2)))));f&&(e&&!this.whiteInCheck()?(!(0<=this.board.castlingOptions.indexOf("K"))||
this.board.hasPiece(a+1,b)||this.isSquareAttackedByBlack(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByBlack(a+2,b)||d.push(h.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("Q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByBlack(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByBlack(a-2,b)||d.push(h.name(a-2,b))):e||this.blackInCheck()||(!(0<=this.board.castlingOptions.indexOf("k"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByWhite(a+1,b)||this.board.hasPiece(a+
2,b)||this.isSquareAttackedByWhite(a+2,b)||d.push(h.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByWhite(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByWhite(a-2,b)||d.push(h.name(a-2,b))));return d},isPromotionPossible:function(a){a=h.coords(a.substr(0,2));if(this.board.hasPiece(a.file,a.rank)){var b=this.board.getPiece(a.file,a.rank);if("p"==b&&2==a.rank||"P"==b&&7==a.rank)return!0}return!1},isValidMove:function(a,b){var d,
c;d="object"==typeof a?a:h.coords(a.substr(0,2));c="object"==typeof b?h.name(b.file,b.rank):a.substr(2,3);if(!this.board.hasPiece(d.file,d.rank)||p.getColor(this.board.getPiece(d.file,d.rank))!=this.board.getColorToMove())return!1;d=this.getValidMovesForSquare(d.file,d.rank);for(var e=0;e<d.length;e++)if(d[e]===c)return!0;return!1},determineCoveredSquares:function(a){if(!(a&&0<this.whiteCoveredSquares.length||!a&&0<this.blackCoveredSquares.legnth)){a&&(this.whiteCoveredSquares=[]);a||(this.blackCoveredSquares=
[]);for(var b,d=1;9>d;d++)for(var c=1;9>c;c++)if(this.board.hasPiece(d,c)){var e=p.isWhite(this.board.getPiece(d,c));if(e==a){b=this.board.getCoveredSquares(d,c);var f=this.blackCoveredSquares;e&&(f=this.whiteCoveredSquares);for(e=0;e<b.length;e++)f.push(b[e])}}}},findPiece:function(a){for(var b=[],d=1;9>d;d++)for(var c=1;9>c;c++)this.board.hasPiece(d,c)&&this.board.getPiece(d,c)==a&&b.push({file:d,rank:c});return b},isSquareAttacked:function(a,b){if(!this.board.hasPiece(a,b))return!1;var d=h.name(a,
b),c;c=p.isWhite(this.board.getPiece(a,b))?this.getBlacksCoveredSquares():this.getWhitesCoveredSquares();for(var e=0;e<c.length;e++)if(c[e]==d)return!0;return!1},isSquareAttackedByWhite:function(a,b){for(var d=h.name(a,b),c=this.getWhitesCoveredSquares(),e=0;e<c.length;e++)if(c[e]==d)return!0;return!1},isSquareAttackedByBlack:function(a,b){for(var d=h.name(a,b),c=this.getBlacksCoveredSquares(),e=0;e<c.length;e++)if(c[e]==d)return!0;return!1},getPositionFEN:function(){if(this.cachedPositionFEN)return this.cachedPositionFEN;
for(var a=[],b=8;0<b;b--){for(var d="",c=0,e=1;9>e;e++)this.board.hasPiece(e,b)?(0<c&&(d+=c,c=0),d+=this.board.getPiece(e,b)):c++;0<c&&(d+=c);a.push(d)}return this.cachedPositionFEN=a.join("/")},setFEN:function(a){this.resetCaches();this.board.setFEN(a)},setFromBoard:function(a){this.resetCaches();this.board.copyFrom(a)},blackInCheck:function(){var a=this.findPiece("k");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)},whiteInCheck:function(){var a=this.findPiece("K");return 0==a.length?
!1:this.isSquareAttacked(a[0].file,a[0].rank)},blackInCheckmate:function(){var a=this.findPiece("k");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)&&0==this.getValidMovesForBlack().length},whiteInCheckmate:function(){var a=this.findPiece("K");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)&&0==this.getValidMovesForWhite().length},moves:function(a){"string"==typeof a&&(a=a.split(" "));for(var b=0;b<a.length;b++)if(!this.move(a[b]))return!1;return!0},move:function(a,
b){var d,c,e,f;b=!0===b?!0:!1;d=h.coords(a.substr(0,2));var g=h.coords(a.substr(2,2)),k=null;4<a.length&&(k=a.substr(4,1));if(!this.board.hasPiece(d.file,d.rank)||!b&&!this.isValidMove(a))return!1;c=this.board.getPiece(d.file,d.rank);this.board.removePiece(d.file,d.rank);this.board.setPiece(c,g.file,g.rank);if(("k"==c||"K"==c)&&2==Math.abs(d.file-g.file)){g.file>d.file?(e=g.file+1,f=g.rank,d=g.file-1):(e=g.file-2,f=g.rank,d=g.file+1);c=g.rank;var n=this.board.getPiece(e,f);this.board.removePiece(e,
f);this.board.setPiece(n,d,c);p.isWhite(n)?this.board.castlingOptions=this.board.castlingOptions.replace("KQ",""):this.board.castlingOptions=this.board.castlingOptions.replace("kq","");""==this.board.castlingOptions&&(this.board.castlingOptions="-")}k&&this.board.setPiece(k,g.file,g.rank);this.board.incrementMove();this.resetCaches();return!0},getWhiteStaticValue:function(){this.determineStaticValues();return this.whiteStaticValue},getBlackStaticValue:function(){this.determineStaticValues();return this.blackStaticValue},
determineStaticValues:function(){if(!(0<this.whiteStaticValue||0<this.blackStaticValue)){this.blackStaticValue=this.whiteStaticValue=0;for(var a,b=1;9>b;b++)for(var c=1;9>c;c++)if(this.board.hasPiece(b,c)){switch(this.board.getPiece(b,c)){case "Q":case "q":a=9.75;break;case "R":case "r":a=5;break;case "B":case "b":a=3.25;break;case "N":case "n":a=3.25;break;case "P":case "p":a=1;break;default:continue}a*=10;p.isWhite(this.board.getPiece(b,c))?this.whiteStaticValue+=a:this.blackStaticValue+=a}}},getWhiteDynamicValue:function(){this.determineDynamicValues();
return this.whiteDynamicValue},getBlackDynamicValue:function(){this.determineDynamicValues();return this.blackDynamicValue},determineDynamicValues:function(){if(!(0<this.whiteDynamicValue||0<this.blackDynamicValue)){this.blackDynamicValue=this.whiteDynamicValue=0;2<=this.findPiece("b").length&&(this.blackDynamicValue+=5);2<=this.findPiece("B").length&&(this.whiteDynamicValue+=5);var a=this.getBlacksCoveredSquares();this.blackDynamicValue+=Math.round(a.length/2);a=this.getWhitesCoveredSquares();this.whiteDynamicValue+=
Math.round(a.length/2)}},getBestMoveForWhite:function(){return this.getBestMove(!0)},getBestMoveForBlack:function(){return this.getBestMove(!1)},getBestMoveSimple:function(a){for(var b=[],c=1;9>c;c++)for(var f=1;9>f;f++)if(this.board.hasPiece(c,f)&&p.isWhite(this.board.getPiece(c,f))==a){var e=this.getValidMovesForSquare(c,f);if(0!=e.length)for(var l=0;l<e.length;l++){var g=""+h.name(c,f)+e[l].name,k=this.evaluateMove(g);if(1E3==Math.abs(k))return g;b.push({move:g,value:k})}}c=function(a,b){return a.value-
b.value};a&&(c=function(a,b){return b.value-a.value});b.sort(c);if(this.mark)for(l=0;l<b.length;l++)console.log(b[l].move+": "+b[l].value);return b[0].move},evaluateMove:function(a){var b=this.clone();b.move(a);return b.evaluatePosition()},clone:function(){var a=EngineFactory.create();a.setFromBoard(a.board);return a}},c,f;r.getBestMove=function(a){this.lastBestMove="";c=this.lastValue=0;f={};var b=(new Date).getTime();this.alphabeta(3,-1E4,1E4,a);b=((new Date).getTime()-b)/1E3;console.log((a?"white":
"black")+" to move; examined: "+c+" nodes in "+b+"s ("+Math.round(c/b)+"n/s); best: "+this.lastBestMove+" ("+this.lastValue+")");return this.lastBestMove};r.alphabeta=function(a,b,d,h){c++;var e=this.getPositionFEN()+" "+(this.board.getColorToMove()==m.white?"w":"b"),l;if(0==a){if(f[e])return f[e];l=this.evaluatePosition();return f[e]=l}var e=this.clone(),g,k;if(h){g=this.getValidMovesForWhite();for(var n=0;n<g.length;n++){e.setFromBoard(this.board);e.move(g[n]);k=b;if(e.blackInCheckmate()){b=1E3;
this.lastBestMove=g[n];this.lastValue=b;break}else l=e.alphabeta(a-1,b,d,!h),b=Math.max(b,l);k!=b&&(this.lastBestMove=g[n],this.lastValue=l);if(d<=b)break}return b}g=this.getValidMovesForBlack();for(n=0;n<g.length;n++){e.setFromBoard(this.board);e.move(g[n]);k=d;if(e.whiteInCheckmate()){d=-1E3;this.lastBestMove=g[n];this.lastValue=d;break}else l=e.alphabeta(a-1,b,d,!h),d=Math.min(d,l);k!=d&&(this.lastBestMove=g[n],this.lastValue=d);if(d<=b)break}return d};r.evaluatePosition=function(){if(this.whiteInCheckmate())return-1E3;
if(this.blackInCheckmate())return 1E3;var a;a=0+this.getWhiteStaticValue();a-=this.getBlackStaticValue();a+=this.getWhiteDynamicValue();return a-=this.getBlackDynamicValue()};EngineFactory=function(){return{create:function(a){"undefined"===typeof a&&(a=BoardFactory.create());return Object.create(r).init(a)}}}()})();
