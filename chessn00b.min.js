var BoardFactory;
(function(){"function"!==typeof Object.create&&(Object.create=function(a){function b(){}b.prototype=a;return new b});var n={R:"\u2656",N:"\u2658",B:"\u2657",Q:"\u2655",K:"\u2654",P:"\u2659",r:"\u265c",n:"\u265e",b:"\u265d",q:"\u265b",k:"\u265a",p:"\u265f",isWhite:function(a){if("string"!=typeof a)throw Error('Got a non-string piece "'+a+'"');return 91>a.charCodeAt(0)?!0:!1},getColor:function(a){return this.isWhite(a)?m.white:m.black}},k={1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g",8:"h",a:"1",b:"2",
c:"3",d:"4",e:"5",f:"6",g:"7",h:"8",name:function(a,b){return k[a]+b},coords:function(a){return{file:parseInt(k[a.substr(0,1)],10),rank:parseInt(a.substr(1,1),10)}}},m={white:8,black:0},p={init:function(){this.colorToMove=m.white;this.enpassantTarget=this.castlingOptions="-";this.fullMoveNumber=this.halfMoveClock=0;this.squares=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,
-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];this.squareColors=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,8,0,8,0,8,0,8,0,-1,-1,0,8,0,8,0,8,0,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];return this},copyFrom:function(a){this.squares=a.squares.slice();
this.colorToMove=a.colorToMove;this.castlingOptions=a.castlingOptions;this.enpassantTarget=a.enpassantTarget;this.haveMoveClock=a.halfMoveClock;this.fullMoveNumber=a.fullMoveNumber},setFEN:function(a){a=a.split(" ");for(var b=a[0].split("/"),c=8;0<c;c--)this.setRankFEN(c,b[8-c]);this.colorToMove="w"==a[1]?m.white:m.black;a[2]&&(this.castlingOptions=a[2]);a[3]&&(this.enpassantTarget=a[3]);"undefined"!=typeof a[4]&&(this.halfMoveClock=parseInt(a[4],10));"undefined"!=typeof a[5]&&(this.fullMoveNumber=
parseInt(a[5],10))},setRankFEN:function(a,b){var c=b.split(""),e=1,d;for(d in c){if(8<e||" "==c[d])break;if(n[c[d]])this.setPiece(c[d],e,a),e++;else for(;0<c[d];)this.removePiece(e,a),c[d]--,e++}},getColorToMove:function(){return this.colorToMove},incrementMove:function(){this.colorToMove==m.white?this.colorToMove=m.black:(this.colorToMove=m.white,this.fullMoveNumber++)},ap:function(a,b){return 10*(10-parseInt(b,10))+parseInt(a,10)},apToName:function(a){return k.name(a%10,10-Math.floor(a/10))},setPiece:function(a,
b,c){this.squares[this.ap(b,c)]=a},removePiece:function(a,b){this.squares[this.ap(a,b)]=0},hasPiece:function(a,b){var c;c="undefined"===typeof b?a:this.ap(a,b);return"string"===typeof this.squares[c]?!0:!1},getPiece:function(a,b){return this.squares[this.ap(a,b)]},getPieceCount:function(){for(var a=0,b=8;0<b;b--)for(var c=1;9>c;c++)this.hasPiece(c,b)&&a++;return a},getSquareColor:function(a,b){"undefined"==typeof b&&"string"==typeof a&&(b=a.substr(1,1),a=k[a.substr(0,1)]);return this.squareColors[this.ap(a,
b)]},getCoveredSquares:function(a,b){var c=[],e=[];switch(this.getPiece(a,b)){case "K":case "k":c=this.getStraightOptions(a,b,1);e=this.getDiagonalOptions(a,b,1);break;case "Q":case "q":c=this.getStraightOptions(a,b,8);e=this.getDiagonalOptions(a,b,8);break;case "R":case "r":c=this.getStraightOptions(a,b,8);break;case "B":case "b":e=this.getDiagonalOptions(a,b,8);break;case "N":case "n":c=this.getKnightOptions(a,b);break;case "P":case "p":c=this.getPawnOptions(a,b)}for(var d=0;d<e.length;d++)c.push(e[d]);
return c},getStraightOptions:function(a,b,c){for(var e=[],d=[-1,-10,1,10],h=this.ap(a,b),f,g=0;g<d.length;g++)for(b=d[g],f=h,a=0;a<c;){f+=b;if(0>this.squares[f])break;e.push(this.apToName(f));if(this.hasPiece(f))break;a++}return e},getDiagonalOptions:function(a,b,c){for(var e=[],d=[-11,-9,9,11],h=this.ap(a,b),f,g=0;g<d.length;g++)for(b=d[g],f=h,a=0;a<c;){f+=b;if(0>this.squares[f])break;e.push(this.apToName(f));if(this.hasPiece(f))break;a++}return e},getKnightOptions:function(a,b){for(var c=[],e=[-21,
-19,-8,12,21,19,8,-12],d,h=this.ap(a,b),f=0;f<e.length;f++)d=e[f],d=h+d,0>this.squares[d]||c.push(this.apToName(d));return c},getPawnOptions:function(a,b){for(var c=[],e=n.isWhite(this.getPiece(a,b))?[-11,-9]:[11,9],d,h=this.ap(a,b),f=0;f<e.length;f++)d=e[f],d=h+d,0>this.squares[d]||c.push(this.apToName(d));return c},dump:function(){console.log("-----------------");for(var a=8;0<a;a--){for(var b="|",c=1;9>c;c++)b=this.hasPiece(c,a)?b+this.getPiece(c,a):b+" ",b+="|";console.log(b);console.log("-----------------")}}};
BoardFactory=function(){return{create:function(){return Object.create(p).init()},getPieceMap:function(){return n},getFileMap:function(){return k},getColorMap:function(){return m}}}()})();
(function(n){n.fn.chessn00b=function(a){a||(a={});if("string"==typeof a&&1==this.length&&this[0].displayboard)switch(a){case "fen":return this[0].displayboard.getFEN();default:return"unsupported option"}return this.each(function(){if(!this.displayboard){var b="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";a.fen&&(b=a.fen);a.element=n(this);this.displayboard=Object.create(c).init(a);this.displayboard.setFEN(b)}})};var k=BoardFactory.getPieceMap(),m=BoardFactory.getColorMap(),p=BoardFactory.getFileMap(),
a={"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR":["e7e5"],"rnbqkbnr/pppppppp/8/8/3P4/8/PPP1PPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppppppp/8/8/2P5/8/PP1PPPPP/RNBQKBNR":["g8f6"],"rnbqkbnr/pppp1ppp/8/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R":["b8c6"],"rnbqkb1r/pppppppp/5n2/8/2PP4/8/PP2PPPP/RNBQKBNR":["g7g6"]},b={init:function(a){this.square=a;this.element=n('<div class="chessn00b-square">&nbsp;</div>');this.element[0].displaySquare=this;this.element.attr("rel",a.name);this.element.addClass(this.square.color==m.white?
"chessn00b-light-square":"chessn00b-dark-square");return this},lite:function(){this.element.addClass("chessn00b-square-lit")},unlite:function(){this.element.removeClass("chessn00b-square-lit")},toggleLite:function(){this.element.hasClass("chessn00b-square-lit")?this.unlite():this.lite()}},c={init:function(a){if(!a||!a.element)throw Error('Missing options; requires at least "element" to attach to.');"undefined"===typeof a.playGame&&(a.playGame=!0);a.displayGameScore=!1;"undefined"===typeof a.gameScoreSelector?
a.displayGameScore=!1:"string"===typeof a.gameScoreSelector&&(this.gameScoreElement=n(a.gameScoreSelector),0<this.gameScoreElement.length&&(a.displayGameScore=!0));"undefined"===typeof a.notationType&&(a.notationType="SAN");"boolean"!==typeof a.coordinates&&(a.coordinates=!1);this.element=a.element;this.board=BoardFactory.create();this.engine=EngineFactory.create(this.board);this.playGame=a.playGame;this.lastClickedSquare=null;this.displaySquares=[];this.thinking=!1;this.options=a;this.gameScore=
"";this.currentPieceCount=this.board.getPieceCount();this.id="board"+Math.floor(1E6*Math.random());this.element.addClass(this.id);for(a=1;9>a;a++)for(var d=1;9>d;d++)1==d&&(this.displaySquares[a]=[]),this.displaySquares[a][d]=Object.create(b).init({file:a,rank:d,color:this.board.getSquareColor(a,d),name:p.name(a,d)});this.createDisplay();return this},createDisplay:function(){this.element.append('<div class="chessn00b-outer-board"><div class="chessn00b-inner-board"></div></div>');for(var a=this.element.find(".chessn00b-inner-board"),
b=this.element.find(".chessn00b-outer-board"),c=8;0<c;c--){for(var f=n('<div class="chessn00b-rank" rel="'+c+'"></div>'),g=1;9>g;g++)f.append(this.displaySquares[g][c].element);a.append(f)}if(this.options.coordinates){a=n('<div class="chessn00b-file-markers"></div>');for(g=1;9>g;g++)a.append('<div class="chessn00b-file-marker">'+p[g]+"</div>");g=n('<div class="chessn00b-rank-markers"></div>');for(c=8;0<c;c--)g.append('<div class="chessn00b-rank-marker">'+c+"</div>");b.append(g);b.append(a)}this.element.append('<div class="chessn00b-status"><span class="illegal-move">Illegal move. </span><span class="your-move">Your move</span><span class="game-over">Game Over. </span><span class="you-win">You win!</span><span class="you-lose">You win!</span><span class="thinking">Thinking...</span></div>');
this.element.find(".illegal-move").hide();this.element.find(".thinking").hide();this.element.find(".game-over").hide();this.element.find(".you-lose").hide();this.element.find(".you-win").hide();this.element.append('<div class="chessn00b-promote"><a href="#" class="chessn00b-square promote-white" rel="Q">'+k.Q+'</a><a href="#" class="chessn00b-square promote-black" rel="q">'+k.q+'</a><a href="#" class="chessn00b-square promote-white" rel="R">'+k.R+'</a><a href="#" class="chessn00b-square promote-black" rel="r">'+
k.r+'</a><a href="#" class="chessn00b-square promote-white" rel="B">'+k.B+'</a><a href="#" class="chessn00b-square promote-black" rel="b">'+k.b+'</a><a href="#" class="chessn00b-square promote-white" rel="N">'+k.N+'</a><a href="#" class="chessn00b-square promote-black" rel="n">'+k.n+"</a></div>");this.element.append('<div class="chessn00b-animator chessn00b-square"></div>');this.playGame||this.element.find(".your-move").hide();this.autosetHeight();var l=this;this.element.on("click",".chessn00b-rank .chessn00b-square",
function(){l.squareClicked(n(this));return!1})},autosetHeight:function(){var a=Math.ceil(this.element.width()/9);"undefined"==typeof this.dynCSS&&(this.dynCSS=document.createElement("style"),document.getElementsByTagName("head")[0].appendChild(this.dynCSS));var b="."+this.id+" .chessn00b-inner-board, .chessn00b-file-markers { width: "+8*a+"px; }",b=b+("."+this.id+" .chessn00b-square { font-size: "+Math.ceil(.82*a)+"px;  height: "+a+"px;  line-height: "+a+"px; }"),b=b+("."+this.id+" .chessn00b-rank-marker { height: "+
a+"px;  line-height: "+a+"px; }"),b=b+("."+this.id+" .chessn00b-promote {  top: -"+Math.ceil(5*a)+"px; left: "+Math.ceil(2.2*a)+"px; }"),b=b+("."+this.id+" .chessn00b-animator {  width: "+a+"px; }");this.dynCSS.styleSheet?this.dynCSS.styleSheet.cssText=b:this.dynCSS.innerHTML=b},squareClicked:function(a){if(!this.thinking)if(this.element.find(".illegal-move").hide(),this.lastClickedSquare)if(a[0]==this.lastClickedSquare)this.lastClickedSquare.displaySquare.unlite(),this.lastClickedSquare=null;else{this.lastClickedSquare.displaySquare.unlite();
var b=""+this.lastClickedSquare.displaySquare.square.name+a[0].displaySquare.square.name,c=this,f=function(){c.engine.isValidMove(b)?(c.engine.move(b),c.update(b),c.lastClickedSquare=null,c.playGame&&c.autoMove()):(c.element.find(".illegal-move").show(),c.lastClickedSquare=null)};this.engine.isPromotionPossible(b)?(this.element.find(".chessn00b-promote").css("display","inline-block"),this.element.find(".chessn00b-promote .promote-white").show(),this.element.find(".chessn00b-promote .promote-black").hide(),
this.element.on("click.promote","a",function(){c.element.off("click.promote");c.element.find(".chessn00b-promote").hide();b+=n(this).attr("rel");f();return!1})):f()}else a[0].displaySquare.lite(),this.lastClickedSquare=a[0]},autoMove:function(){this.thinking=!0;this.element.find(".your-move").hide();this.element.find(".thinking").show();var b=this;setTimeout(function(){var c;b.engine.blackInCheckmate()?(b.thinking=!1,b.element.find(".thinking").hide(),b.element.find(".game-over").show(),b.element.find(".you-win").show()):
((c=a[b.getFEN()])?(c=c[Math.round(Math.random()*(c.length-1))],console.log("book move used")):c=b.engine.getBestMoveForBlack(),b.engine.move(c),b.animate(c),b.thinking=!1,b.element.find(".thinking").hide(),b.engine.whiteInCheckmate()?(b.element.find(".game-over").show(),b.element.find(".you-lose").show()):b.element.find(".your-move").show())},20)},setFEN:function(a){this.board.setFEN(a);this.update()},getFEN:function(){return this.engine.getPositionFEN()},update:function(a){this.updateDisplayBoard();
"undefined"!==typeof a&&this.updateGameScore(a)},updateDisplayBoard:function(){for(var a=1;9>a;a++)for(var b=1;9>b;b++)this.board.hasPiece(a,b)?this.displaySquares[a][b].element.html(k[this.board.getPiece(a,b)]):this.displaySquares[a][b].element.html("&nbsp;")},updateGameScore:function(a){var b=this.board.getPieceCount(),c=!1;b<this.currentPieceCount&&(c=!0);this.currentPieceCount=b;b="";this.board.colorToMove!=m.white&&(b+=""+this.board.fullMoveNumber+". ");b+=this.convertNotation(a,c);this.board.colorToMove==
m.white&&this.engine.whiteInCheck()?b+="+":this.board.colorToMove==m.black&&this.engine.blackInCheck()&&(b+="+");this.gameScore+=b+" ";this.options.displayGameScore&&this.gameScoreElement.html(this.gameScore)},convertNotation:function(a,b){var c=p.coords(a.substr(0,2)),f=p.coords(a.substr(2,2)),g=a.substr(2,3),l=this.board.getPiece(f.file,f.rank);"p"==l||"P"==l?c=b?a.substr(0,1)+"x"+g:g:"k"!=l&&"K"!=l||2!=Math.abs(c.file-f.file)?(c="FAN"==this.options.notationType?k[l]:l.toUpperCase(),b&&(c+="x"),
c+=g):c=c.file<f.file?"O-O":"O-O-O";return c},animate:function(a){var b=p.coords(a.substr(0,2)),c=p.coords(a.substr(2,2)),f=this.displaySquares[c.file][c.rank].element.offset(),g=this.element.find(".chessn00b-animator"),l=this.displaySquares[b.file][b.rank].element.offset();g.html(k[this.board.getPiece(c.file,c.rank)]);this.displaySquares[b.file][b.rank].element.html("&nbsp;");var n=this;g.css("top",l.top+"px").css("left",l.left+"px").css("display","block").animate({left:f.left,top:f.top},400,function(){g.css("display",
"none");n.update(a)})}}})(jQuery);if("undefined"===typeof BoardFactory)throw console&&console.log("Missing the BoardFactory!"),Error("Missing the BoardFactory!");var EngineFactory;
(function(){var n=BoardFactory.getPieceMap();BoardFactory.getColorMap();var k=BoardFactory.getFileMap(),m={init:function(a){this.board=a;this.searchPly=3;this.resetCaches();return this},resetCaches:function(){this.whiteCoveredSquares=[];this.blackCoveredSquares=[];this.blackDynamicValue=this.whiteDynamicValue=this.blackStaticValue=this.whiteStaticValue=0;this.cachedPositionFEN=null;this.validWhiteMoves=[];this.validBlackMoves=[]},getWhitesCoveredSquares:function(){this.determineCoveredSquares(!0);
return this.whiteCoveredSquares},getBlacksCoveredSquares:function(){this.determineCoveredSquares(!1);return this.blackCoveredSquares},getValidMovesForWhite:function(){this.determineValidMoves(!0);return this.validWhiteMoves},getValidMovesForBlack:function(){this.determineValidMoves(!1);return this.validBlackMoves},getValidMovesFor:function(a){this.determineValidMoves(a);return a?this.validWhiteMoves:this.validBlackMoves},determineValidMoves:function(a){if(!(a&&0<this.validWhiteMoves.length||!a&&0<
this.validBlackMoves.length)){a&&(this.validWhiteMoves=[]);a||(this.validBlackMoves=[]);for(var b,c,e,d,h=1;9>h;h++)for(var f=1;9>f;f++)if(this.board.hasPiece(h,f)&&(b=k.name(h,f),e=n.isWhite(this.board.getPiece(h,f)),e==a)){d=this.getValidMovesForSquare(h,f);for(var g=0;g<d.length;g++)c=""+b+d[g],e?this.validWhiteMoves.push(c):this.validBlackMoves.push(c)}}},getValidMovesForSquare:function(a,b){var c=[];if(!this.board.hasPiece(a,b))return c;var e=this.board.getPiece(a,b),d=n.isWhite(e),h="k"==e||
"K"==e?!0:!1,f="p"==e||"P"==e?!0:!1,e=k.name(a,b);this.getPositionFEN();var g=EngineFactory.create(),l=this.board.getCoveredSquares(a,b);if(0==l.length)return c;for(var m,p,r,q=0;q<l.length;q++)m=k[l[q].substr(0,1)],p=l[q].substr(1,1),r=this.board.hasPiece(m,p),m=this.board.getPiece(m,p),r&&n.isWhite(m)==d||f&&!r||(g.setFromBoard(this.board),r=""+e+l[q],g.move(r,!0),d&&g.whiteInCheck()||!d&&g.blackInCheck()||(f?d&&8==p?(c.push(l[q]+"Q"),c.push(l[q]+"R"),c.push(l[q]+"B"),c.push(l[q]+"N")):d||1!=p?
c.push(l[q]):(c.push(l[q]+"q"),c.push(l[q]+"r"),c.push(l[q]+"b"),c.push(l[q]+"n")):c.push(l[q])));f&&(d?8>b&&!this.board.hasPiece(a,b+1)&&(g.setFromBoard(this.board),r=""+e+k.name(a,b+1),g.move(r,!0),g.whiteInCheck()||(7>b?c.push(k.name(a,b+1)):(f=k.name(a,b+1),c.push(f+"Q"),c.push(f+"R"),c.push(f+"N"),c.push(f+"B"))),2!=b||this.board.hasPiece(a,b+2)||(g.setFromBoard(this.board),r=""+e+k.name(a,b+2),g.move(r,!0),g.whiteInCheck()||c.push(k.name(a,b+2)))):1<b&&!this.board.hasPiece(a,b-1)&&(g.setFromBoard(this.board),
r=""+e+k.name(a,b-1),g.move(r,!0),g.blackInCheck()||(2<b?c.push(k.name(a,b-1)):(f=k.name(a,b-1),c.push(f+"q"),c.push(f+"r"),c.push(f+"n"),c.push(f+"b"))),7!=b||this.board.hasPiece(a,b-2)||(g.setFromBoard(this.board),r=""+e+k.name(a,b-2),g.move(r,!0),g.blackInCheck()||c.push(k.name(a,b-2)))));h&&(d&&!this.whiteInCheck()&&1==b?(!(0<=this.board.castlingOptions.indexOf("K"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByBlack(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByBlack(a+2,
b)||c.push(k.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("Q"))||this.board.hasPiece(a-1,b)||this.isSquareAttackedByBlack(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByBlack(a-2,b)||c.push(k.name(a-2,b))):d||this.blackInCheck()||8!=b||(!(0<=this.board.castlingOptions.indexOf("k"))||this.board.hasPiece(a+1,b)||this.isSquareAttackedByWhite(a+1,b)||this.board.hasPiece(a+2,b)||this.isSquareAttackedByWhite(a+2,b)||c.push(k.name(a+2,b)),!(0<=this.board.castlingOptions.indexOf("q"))||
this.board.hasPiece(a-1,b)||this.isSquareAttackedByWhite(a-1,b)||this.board.hasPiece(a-2,b)||this.isSquareAttackedByWhite(a-2,b)||c.push(k.name(a-2,b))));return c},isPromotionPossible:function(a){a=k.coords(a.substr(0,2));if(this.board.hasPiece(a.file,a.rank)){var b=this.board.getPiece(a.file,a.rank);if("p"==b&&2==a.rank||"P"==b&&7==a.rank)return!0}return!1},isValidMove:function(a,b){var c,e;c="object"==typeof a?a:k.coords(a.substr(0,2));e="object"==typeof b?k.name(b.file,b.rank):a.substr(2,3);if(!this.board.hasPiece(c.file,
c.rank)||n.getColor(this.board.getPiece(c.file,c.rank))!=this.board.getColorToMove())return!1;c=this.getValidMovesForSquare(c.file,c.rank);for(var d=0;d<c.length;d++)if(c[d]===e)return!0;return!1},determineCoveredSquares:function(a){if(!(a&&0<this.whiteCoveredSquares.length||!a&&0<this.blackCoveredSquares.legnth)){a&&(this.whiteCoveredSquares=[]);a||(this.blackCoveredSquares=[]);for(var b,c=1;9>c;c++)for(var e=1;9>e;e++)if(this.board.hasPiece(c,e)){var d=n.isWhite(this.board.getPiece(c,e));if(d==
a){b=this.board.getCoveredSquares(c,e);var h=this.blackCoveredSquares;d&&(h=this.whiteCoveredSquares);for(d=0;d<b.length;d++)h.push(b[d])}}}},findPiece:function(a){for(var b=[],c=1;9>c;c++)for(var e=1;9>e;e++)this.board.hasPiece(c,e)&&this.board.getPiece(c,e)==a&&b.push({file:c,rank:e});return b},isSquareAttacked:function(a,b){if(!this.board.hasPiece(a,b))return!1;var c=k.name(a,b),e;e=n.isWhite(this.board.getPiece(a,b))?this.getBlacksCoveredSquares():this.getWhitesCoveredSquares();for(var d=0;d<
e.length;d++)if(e[d]==c)return!0;return!1},isSquareAttackedByWhite:function(a,b){for(var c=k.name(a,b),e=this.getWhitesCoveredSquares(),d=0;d<e.length;d++)if(e[d]==c)return!0;return!1},isSquareAttackedByBlack:function(a,b){for(var c=k.name(a,b),e=this.getBlacksCoveredSquares(),d=0;d<e.length;d++)if(e[d]==c)return!0;return!1},getPositionFEN:function(){if(this.cachedPositionFEN)return this.cachedPositionFEN;for(var a=[],b=8;0<b;b--){for(var c="",e=0,d=1;9>d;d++)this.board.hasPiece(d,b)?(0<e&&(c+=e,
e=0),c+=this.board.getPiece(d,b)):e++;0<e&&(c+=e);a.push(c)}return this.cachedPositionFEN=a.join("/")},setFEN:function(a){this.resetCaches();this.board.setFEN(a)},setFromBoard:function(a){this.resetCaches();this.board.copyFrom(a)},blackInCheck:function(){var a=this.findPiece("k");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)},whiteInCheck:function(){var a=this.findPiece("K");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)},blackInCheckmate:function(){var a=this.findPiece("k");
return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)&&0==this.getValidMovesForBlack().length},whiteInCheckmate:function(){var a=this.findPiece("K");return 0==a.length?!1:this.isSquareAttacked(a[0].file,a[0].rank)&&0==this.getValidMovesForWhite().length},moves:function(a){"string"==typeof a&&(a=a.split(" "));for(var b=0;b<a.length;b++)if(!this.move(a[b]))return!1;return!0},move:function(a,b){var c,e;b=!0===b?!0:!1;var d=k.coords(a.substr(0,2)),h=k.coords(a.substr(2,2)),f=null;4<a.length&&
(f=a.substr(4,1));if(!this.board.hasPiece(d.file,d.rank)||!b&&!this.isValidMove(a))return!1;var g=this.board.getPiece(d.file,d.rank);this.board.removePiece(d.file,d.rank);this.board.setPiece(g,h.file,h.rank);if((c="k"==g||"K"==g?!0:!1)&&2==Math.abs(d.file-h.file)){var l;h.file>d.file?(l={file:h.file+1,rank:h.rank},c=h.file-1):(l={file:h.file-2,rank:h.rank},c=h.file+1);e=h.rank;var m=this.board.getPiece(l.file,l.rank);m||(console.log(d),console.log(h),console.log(l),this.board.dump());this.board.removePiece(l.file,
l.rank);this.board.setPiece(m,c,e);n.isWhite(m)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=this.board.castlingOptions.replace(/[kq]/g,"");""==this.board.castlingOptions&&(this.board.castlingOptions="-")}else c&&(n.isWhite(g)?this.board.castlingOptions=this.board.castlingOptions.replace(/[KQ]/g,""):this.board.castlingOptions=this.board.castlingOptions.replace(/[kq]/g,""));"r"==g?1==d.file?this.board.castlingOptions=this.board.castlingOptions.replace("q",
""):8==d.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("k","")):"R"==g&&(1==d.file?this.board.castlingOptions=this.board.castlingOptions.replace("Q",""):8==d.file&&(this.board.castlingOptions=this.board.castlingOptions.replace("K","")));f&&this.board.setPiece(f,h.file,h.rank);this.board.incrementMove();this.resetCaches();return!0},getWhiteStaticValue:function(){this.determineStaticValues();return this.whiteStaticValue},getBlackStaticValue:function(){this.determineStaticValues();
return this.blackStaticValue},determineStaticValues:function(){if(!(0<this.whiteStaticValue||0<this.blackStaticValue)){this.blackStaticValue=this.whiteStaticValue=0;for(var a,b=1;9>b;b++)for(var c=1;9>c;c++)if(this.board.hasPiece(b,c)){switch(this.board.getPiece(b,c)){case "Q":case "q":a=9.75;break;case "R":case "r":a=5;break;case "B":case "b":a=3.25;break;case "N":case "n":a=3.25;break;case "P":case "p":a=1;break;default:continue}a*=10;n.isWhite(this.board.getPiece(b,c))?this.whiteStaticValue+=a:
this.blackStaticValue+=a}}},getWhiteDynamicValue:function(){this.determineDynamicValues();return this.whiteDynamicValue},getBlackDynamicValue:function(){this.determineDynamicValues();return this.blackDynamicValue},determineDynamicValues:function(){if(!(0<this.whiteDynamicValue||0<this.blackDynamicValue)){this.blackDynamicValue=this.whiteDynamicValue=0;2<=this.findPiece("b").length&&(this.blackDynamicValue+=5);2<=this.findPiece("B").length&&(this.whiteDynamicValue+=5);var a=this.getBlacksCoveredSquares();
this.blackDynamicValue+=Math.round(a.length/2);a=this.getWhitesCoveredSquares();this.whiteDynamicValue+=Math.round(a.length/2)}},getBestMoveForWhite:function(){return this.getBestMove(!0)},getBestMoveForBlack:function(){return this.getBestMove(!1)},getBestMoveSimple:function(a){for(var b=[],c=1;9>c;c++)for(var e=1;9>e;e++)if(this.board.hasPiece(c,e)&&n.isWhite(this.board.getPiece(c,e))==a){var d=this.getValidMovesForSquare(c,e);if(0!=d.length)for(var h=0;h<d.length;h++){var f=""+k.name(c,e)+d[h].name,
g=this.evaluateMove(f);if(1E3==Math.abs(g))return f;b.push({move:f,value:g})}}c=function(a,b){return a.value-b.value};a&&(c=function(a,b){return b.value-a.value});b.sort(c);if(this.mark)for(h=0;h<b.length;h++)console.log(b[h].move+": "+b[h].value);return b[0].move},evaluateMove:function(a){var b=this.clone();b.move(a);return b.evaluatePosition()},clone:function(){var a=EngineFactory.create();a.setFromBoard(this.board);return a}},p;m.getBestMove=function(a){this.lastBestMove="";p=this.lastValue=0;
var b=(new Date).getTime();this.alphabeta(this.searchPly,-1E4,1E4,a);b=((new Date).getTime()-b)/1E3;console.log((a?"white":"black")+" to move; examined: "+p+" nodes in "+b+"s ("+Math.round(p/b)+"n/s); best: "+this.lastBestMove+" ("+this.lastValue+")");return this.lastBestMove};m.alphabetaNew=function(a,b,c,e){p++;if(0==a)return this.evaluatePosition();var d=this.getValidMovesFor(e),h=d.length;if(0==h)return this.evaluatePosition();for(var f,g=0;g<h;g++){f=this.clone();f.move(d[g]);f=f.alphabeta(a-
1,b,c,!e);if(e){if(b<f&&(b=f,this.lastBestMove=d[g],this.lastValue=f,1E3==f))break}else if(c>f&&(c=f,this.lastBestMove=d[g],this.lastValue=f,-1E3==f))break;if(c<=b)break}return e?c:b};m.alphabeta=function(a,b,c,e){p++;var d;if(0==a)return this.evaluatePosition();var h=this.clone(),f;if(e){f=this.getValidMovesForWhite();for(var g=0;g<f.length;g++){h.setFromBoard(this.board);h.move(f[g]);if(h.blackInCheckmate()){b=1E3;this.lastBestMove=f[g];this.lastValue=b;break}d=h.alphabeta(a-1,b,c,!e);b<d&&(b=d,
this.lastBestMove=f[g],this.lastValue=d);if(c<=b)break}return b}f=this.getValidMovesForBlack();for(g=0;g<f.length;g++){h.setFromBoard(this.board);h.move(f[g]);5==a&&h.board.dump();if(h.whiteInCheckmate()){c=-1E3;this.lastBestMove=f[g];this.lastValue=c;break}d=h.alphabeta(a-1,b,c,!e);c>d&&(c=d,this.lastBestMove=f[g],this.lastValue=c);if(c<=b)break}return c};m.evaluatePosition=function(){if(this.whiteInCheckmate())return-1E3;if(this.blackInCheckmate())return 1E3;var a;a=0+this.getWhiteStaticValue();
a-=this.getBlackStaticValue();a+=this.getWhiteDynamicValue();return a-=this.getBlackDynamicValue()};EngineFactory=function(){return{create:function(a){"undefined"===typeof a&&(a=BoardFactory.create());return Object.create(m).init(a)}}}()})();
